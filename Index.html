<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
<script src="https://cdn.tailwindcss.com"></script>

<meta name="theme-color" content="#007AFF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  * { -webkit-tap-highlight-color: transparent; }
  body { 
    overscroll-behavior: none; 
    -webkit-overflow-scrolling: touch;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
    background: #F2F2F7;
  }
  
  .card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .card:active {
    transform: scale(0.98);
  }
  
  .slot {
    background: white;
    border-radius: 14px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.04);
  }
  
  .current-time {
    background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
    color: white !important;
    box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    transform: scale(1.02);
    border: none;
  }
  
  .current-time * {
    color: white !important;
  }
  
  .past-slot {
    opacity: 0.5;
    background: #F9F9F9;
  }
  
  .skipped-slot {
    background: #FFE8E8;
    border-color: #FFD1D1;
  }
  
  .btn-primary {
    background: #007AFF;
    color: white;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,122,255,0.25);
  }
  
  .btn-primary:active {
    transform: scale(0.96);
    box-shadow: 0 1px 4px rgba(0,122,255,0.2);
  }
  
  .btn-secondary {
    background: #F2F2F7;
    color: #1C1C1E;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .btn-secondary:active {
    transform: scale(0.96);
    background: #E5E5EA;
  }
  
  /* –ü–ª–∞–≤–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å overshoot */
  .progress-bar-inner {
    transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); /* spring-curve */
    background: linear-gradient(90deg, #34C759 0%, #30D158 100%);
  }

  /* –ü—Ä–æ—Ü–µ–Ω—Ç—ã */
  .progress-percent {
    display: inline-block;
    font-variant-numeric: tabular-nums;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.25s ease;
  }

  .progress-percent.bump {
    transform: scale(1.2);
    opacity: 0.85;
  }
  .progress-bar-fill {
    height: 8px;
    border-radius: 4px;
    transition: width 0.5s ease-out;
}

  /* –°—á—ë—Ç—á–∏–∫ X –∏–∑ Y */
  .supp-counter {
    transition: opacity 0.2s ease;
  }

  .supp-counter.fade {
    opacity: 0.4;
  }

  .supp-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid #C7C7CC;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
  }
  
  .supp-checkbox.checked {
    background: #34C759;
    border-color: #34C759;
    color: white;
  }
  
  .skip-btn {
    background: #FF3B30;
    color: white;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(255,59,48,0.2);
  }
  
  .skip-btn:active {
    transform: scale(0.95);
  }
  
  .skip-btn.skipped {
    background: #FF9500;
  }
  
  .day-btn {
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s;
    color: #007AFF;
    background: white;
  }
  
  .day-btn.active {
    background: #007AFF;
    color: white;
    box-shadow: 0 2px 8px rgba(0,122,255,0.3);
  }
  
  .day-btn:active {
    transform: scale(0.95);
  }
  
  .category-btn {
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  
  .category-btn:active {
    transform: scale(0.96);
  }
  
  .header-title {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #1C1C1E;
  }
  
  .tab-btn {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-weight: 600;
    color: #8E8E93;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
  }
  
  .tab-btn.active {
    color: #007AFF;
    border-bottom-color: #007AFF;
  }
  
  .tab-btn:active {
    transform: scale(0.96);
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .slot {
    animation: slideIn 0.3s ease;
  }
  
  @keyframes ringGrow {
    from {
      stroke-dashoffset: 440;
    }
  }
  
  .activity-ring {
    animation: ringGrow 1s ease-out;
  }
  
  .notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: white;
    border-radius: 16px;
    padding: 16px 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    z-index: 1000;
    min-width: 300px;
    animation: slideDown 0.4s ease-out forwards;
  }
  
  @keyframes slideDown {
    to {
      transform: translateX(-50%) translateY(0);
    }
  }
  
  .notification.hide {
    animation: slideUp 0.4s ease-out forwards;
  }
  
  @keyframes slideUp {
    to {
      transform: translateX(-50%) translateY(-100px);
      opacity: 0;
    }
  }
  
  .trend-up {
    color: #34C759;
  }
  
  .trend-down {
    color: #FF3B30;
  }
  
  .chart-bar {
    transition: height 0.5s ease-out;
  }
</style>
</head>

<body class="flex flex-col min-h-screen">
<div id="notification-container"></div>
<div id="app" class="flex-1 flex flex-col overflow-hidden pb-20"></div>

<script>
const storage = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
};

// Haptic feedback helper
const haptic = {
  light: () => {
    if (navigator.vibrate) navigator.vibrate(10);
  },
  medium: () => {
    if (navigator.vibrate) navigator.vibrate(20);
  },
  heavy: () => {
    if (navigator.vibrate) navigator.vibrate(30);
  },
  success: () => {
    if (navigator.vibrate) navigator.vibrate([10, 50, 10]);
  }
};

class Planner {
constructor(){
  const today=new Date();
  this.days=['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
  this.state={
    selectedDay: today.getDay()===0?6:today.getDay()-1,
    currentTab: 'schedule',
    schedule: storage.get('schedule') || {
      0:{work:true,gym:true,repair:true},
      1:{work:false,gym:false,repair:true},
      2:{work:true,gym:true,repair:true},
      3:{work:false,gym:false,repair:true},
      4:{work:true,gym:true,repair:true},
      5:{work:false,gym:false,repair:true},
      6:{work:false,gym:true,repair:true}
    },
    skipped: storage.get('skipped') ?? {},
    supplements: storage.get('supplements') ?? {},
    notifications: storage.get('notifications') || true,
    lastNotification: storage.get('lastNotification') || null,
    suppNotifications: storage.get('suppNotifications') || {}

  };

  this.colors={
    work:{bg:'#FF9500',text:'–†–∞–±–æ—Ç–∞',icon:'üíº'},
    gym:{bg:'#FF3B30',text:'–ó–∞–ª',icon:'üèãÔ∏è'},
    repair:{bg:'#FFCC00',text:'–†–µ–º–æ–Ω—Ç',icon:'üî®'}
  };
  this.slotsElements={};
  this.swipeInit=false;
  this.touchStartX=0;
  this.touchStartY=0;

  this.render();
  this.scrollToCurrent();
  
  setInterval(()=>{
    this.render();
    this.checkNotifications();
    this.checkSuppReminders(); // –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–æ—Ä—Ç–ø–∏—Ç–∞
}, 60000);

  
  this.checkNotifications();
}

save(){
  storage.set('schedule',this.state.schedule);
  storage.set('skipped',this.state.skipped);
  storage.set('supplements',this.state.supplements);
  storage.set('notifications',this.state.notifications);
  storage.set('lastNotification',this.state.lastNotification);
}

getDateForDay(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  const months=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞—è','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return `${m.getDate()} ${months[m.getMonth()]}`;
}

getDateKey(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  return m.toISOString().split('T')[0];
}

toMin(t){
  const[h,m]=t.split(':').map(Number);
  return h*60+m;
}

checkNotifications(){
  if(!this.state.notifications) return;
  
  const now = new Date();
  const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1;
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const slots = this.getSlots(currentDayIndex);
  
  slots.forEach((slot, i) => {
    if(!slot.t.includes('-')) return;
    
    const [startTime] = slot.t.split('-');
    const [startH, startM] = startTime.split(':').map(Number);
    let startMinutes = startH * 60 + startM;
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 10 –º–∏–Ω—É—Ç
    const notifyTime = startMinutes - 10;
    const notifyKey = `${this.getDateKey(currentDayIndex)}-${slot.id}-${i}`;
    
    if(Math.abs(currentMinutes - notifyTime) < 1 && this.state.lastNotification !== notifyKey){
      this.showNotification(`–ß–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç: ${slot.a}`, slot.supps);
      this.state.lastNotification = notifyKey;
      this.save();
    }
  });
}

checkSuppReminders() {
  const now = new Date();
  const dayIndex = this.state.selectedDay;
  const dayDate = this.getDateKey(dayIndex);
  const slots = this.getSlots(dayIndex);

  slots.forEach((slot, i) => {
    if (!slot.supps) return;

    slot.supps.forEach((supp, si) => {
      const key = `${dayDate}-${slot.id}-${i}-s${si}`;
      const suppState = this.state.supplements[key];

      // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–ª–æ—Ç–∞
      const [startTime] = slot.t.split('-');
      const [h, m] = startTime.split(':').map(Number);
      const slotMinutes = h * 60 + m;
      const nowMinutes = now.getHours() * 60 + now.getMinutes();

      // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç
      if (nowMinutes >= slotMinutes - 5 && nowMinutes < slotMinutes && !suppState) {
        if (!this.state.suppNotifications[key]?.notified) {
          this.showNotification(`üíä –ü—Ä–∏—ë–º: ${supp} —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç`);
          this.state.suppNotifications[key] = { notified: true, taken: false };
          this.save();
        }
      }

      // –ü—Ä–æ–ø—É—â–µ–Ω–æ
      if (nowMinutes > slotMinutes + 15 && !suppState) {
        if (!this.state.suppNotifications[key]?.taken) {
          this.showNotification(`‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${supp}`);
          this.state.suppNotifications[key] = { notified: true, taken: false };
          this.save();
        }
      }
    });
  });
}

showNotification(text, supps){
  haptic.medium();
  
  const container = document.getElementById('notification-container');
  const notif = document.createElement('div');
  notif.className = 'notification';
  
  let suppHtml = '';
  if(supps && supps.length > 0){
    suppHtml = `<div class="mt-2 text-sm text-gray-600">üíä ${supps.join(', ')}</div>`;
  }
  
  notif.innerHTML = `
    <div class="flex items-start gap-3">
      <div class="text-2xl">‚è∞</div>
      <div class="flex-1">
        <div class="font-semibold text-gray-900">${text}</div>
        ${suppHtml}
      </div>
    </div>
  `;
  
  container.appendChild(notif);
  
  setTimeout(() => {
    notif.classList.add('hide');
    setTimeout(() => notif.remove(), 400);
  }, 5000);
}

isPast(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex < currentDayIndex) return true;
  if(dayIndex > currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH, endM] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  let endMinutes = endH * 60 + endM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return false;
    }
    return currentMinutes >= endMinutes;
  }
  
  if(endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }
  
  return currentMinutes >= endMinutes;
}

isFuture(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex > currentDayIndex) return true;
  if(dayIndex < currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return true;
    }
    return currentMinutes < startMinutes;
  }
  
  return currentMinutes < startMinutes;
}

isCurrent(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex !== currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH, endM] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  let endMinutes = endH * 60 + endM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return false;
    }
    return currentMinutes >= startMinutes && currentMinutes < endMinutes;
  }
  
  if(endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }
  
  return currentMinutes >= startMinutes && currentMinutes < endMinutes;
}

getSlots(dayIndex){
  const {work,gym,repair}=this.state.schedule[dayIndex];
  const s=[];
  if(work){
    s.push(
      {t:'06:00-06:20',a:'–ü–æ–¥—ä–µ–º',c:'bg-orange-50',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'06:20-06:30',a:'–°–±–æ—Ä—ã',c:'bg-orange-100',id:'prep'},
      {t:'06:30-07:00',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-50',id:'commute1'},
      {t:'07:00-15:00',a:'–†–∞–±–æ—Ç–∞',c:'bg-orange-100',id:'work',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']},
      {t:'15:00-15:30',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-50',id:'commute2'},
      {t:'15:30-16:00',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'}
    );
    s.push(repair
      ?{t:'16:00-19:00',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-50',id:'repair'}
      :{t:'16:00-19:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free1'}
    );
  } else {
    s.push(
      {t:'06:00-09:00',a:'–°–æ–Ω +3—á',c:'bg-indigo-50',id:'sleep2'},
      {t:'09:00-09:30',a:'–ü–æ–¥—ä–µ–º',c:'bg-indigo-100',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'09:30-10:30',a:'–ó–∞–≤—Ç—Ä–∞–∫',c:'bg-green-50',id:'breakfast',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']}
    );
    if(repair){
      s.push(
        {t:'10:30-13:30',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-50',id:'repair1'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'},
        {t:'14:30-18:30',a:'–†–µ–º–æ–Ω—Ç 4—á',c:'bg-yellow-100',id:'repair2'}
      );
    } else {
      s.push(
        {t:'10:30-13:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free2'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'},
        {t:'14:30-18:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free3'}
      );
    }
  }
  if(gym){
    s.push(
      {t:'19:00-19:30',a:'–ö –∑–∞–ª—É',c:'bg-red-50',id:'gym1',supps:['–ë–µ—Ç–∞-–∞–ª–∞–Ω–∏–Ω','–¶–∏—Ç—Ä—É–ª–∏–Ω']},
      {t:'19:30-21:00',a:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',c:'bg-red-100',id:'gym'},
      {t:'21:00-21:30',a:'–û—Ç –∑–∞–ª–∞',c:'bg-red-50',id:'gym2',supps:['–ö—Ä–µ–∞—Ç–∏–Ω','–ì–µ–π–Ω–µ—Ä']},
      {t:'21:30-22:30',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
      {t:'22:30-23:30',a:'–ö—É—Ä—Å',c:'bg-purple-50',id:'course'},
      {t:'23:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
    );
  } else {
    if(work){
      s.push(
        {t:'19:00-20:00',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
        {t:'20:00-22:00',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-100',id:'course'},
        {t:'22:00-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    } else {
      s.push(
        {t:'18:30-19:30',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
        {t:'19:30-21:30',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-100',id:'course'},
        {t:'21:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    }
  }
  s.push({t:'00:00-06:00',a:'–°–æ–Ω',c:'bg-indigo-100',id:'sleep'});
  return s;
}
 
renderDailySuppStats(dayIndex){
  const dayDate = this.getDateKey(dayIndex);
  const slots = this.getSlots(dayIndex);

  let total = 0;
  let taken = 0;

  slots.forEach((slot,i)=>{
    if(slot.supps){
      slot.supps.forEach((_,si)=>{
        total++;
        const key = `${dayDate}-${slot.id}-${i}-s${si}`;
        if(this.state.supplements[key]) taken++;
      });
    }
  });

  if(total === 0) return '';

  const percent = Math.round((taken / total) * 100);

  return `
    <div class="card p-4 mb-4" id="daily-supp-card">
      <div class="flex justify-between items-center mb-2">
        <span class="text-base font-semibold">üíä –°–ø–æ—Ä—Ç–ø–∏—Ç</span>
        <span class="progress-percent text-2xl font-bold" style="color:#34C759;">
          ${percent}%
        </span>
      </div>

      <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden">
        <div class="progress-bar-inner h-full rounded-full"
             style="width:${percent}%"></div>
      </div>

      <div class="mt-2 text-xs text-gray-500 supp-counter">
        ${taken} –∏–∑ ${total} –ø—Ä–∏–Ω—è—Ç—ã
      </div>
    </div>
  `;
}

updateSuppProgress(){
  const card = document.getElementById('daily-supp-card');
  if(!card) return;

  const dayIndex = this.state.selectedDay;
  const dayDate = this.getDateKey(dayIndex);
  const slots = this.getSlots(dayIndex);

  let total = 0;
  let taken = 0;

  slots.forEach((slot,i)=>{
    if(slot.supps){
      slot.supps.forEach((_,si)=>{
        total++;
        const key = `${dayDate}-${slot.id}-${i}-s${si}`;
        if(this.state.supplements[key]) taken++;
      });
    }
  });

  const percent = Math.round((taken / total) * 100);

  // ------------------------
  // 1Ô∏è‚É£ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å overshoot
  const bar = card.querySelector('.progress-bar-inner');

  const overshoot = Math.min(percent + 1, 100);
  bar.style.width = overshoot + '%';

  setTimeout(() => {
    bar.style.width = percent + '%';
    
    // –ï—Å–ª–∏ 100%, –¥–µ–ª–∞–µ–º –ø–æ–¥–ø—Ä—ã–≥
    if(percent === 100){
      bar.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), width 0.6s';
      bar.style.transform = 'scaleY(1.3)';
      bar.style.background = '#28D12E'; // —è—Ä–∫–æ-–∑–µ–ª—ë–Ω—ã–π
      setTimeout(()=>{
        bar.style.transform = 'scaleY(1)';
        bar.style.background = 'linear-gradient(90deg, #34C759 0%, #30D158 100%)';
      }, 300);
    }
  }, 300);

  // ------------------------
  // 2Ô∏è‚É£ –ü—Ä–æ—Ü–µ–Ω—Ç—ã ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Å ¬´–ø—Ä—É–∂–∏–Ω–æ–π¬ª
  const percentEl = card.querySelector('.progress-percent');

  percentEl.classList.remove('bump');
  void percentEl.offsetWidth;
  percentEl.classList.add('bump');

  let current = parseInt(percentEl.textContent) || 0;
  const step = current < percent ? 1 : -1;

  if(this.percentInterval) clearInterval(this.percentInterval);
  this.percentInterval = setInterval(()=>{
    current += step;
    percentEl.textContent = current + '%';
    if((step>0 && current>=percent) || (step<0 && current<=percent)){
      percentEl.textContent = percent + '%';
      clearInterval(this.percentInterval);
    }
  }, 12);

  // ------------------------
  // 3Ô∏è‚É£ –°—á—ë—Ç—á–∏–∫ X –∏–∑ Y —Å –ø–ª–∞–≤–Ω—ã–º fade
  const counter = card.querySelector('.supp-counter');
  counter.classList.add('fade');
  counter.textContent = `${taken} –∏–∑ ${total} –ø—Ä–∏–Ω—è—Ç—ã`;
  setTimeout(()=>counter.classList.remove('fade'),200);
}

renderSchedule(){
  this.slotsElements = {};
  const dayIndex = this.state.selectedDay;
  const dayDate = this.getDateKey(dayIndex);
  const slots = this.getSlots(dayIndex);

  return `
    <div>
      <div class="mb-4">
        <h1 class="header-title">${this.days[dayIndex]}</h1>
        <p class="text-gray-500">${this.getDateForDay(dayIndex)}</p>
      </div>

      ${this.renderDailySuppStats(dayIndex)}

      <div class="flex gap-2 mb-4">
        ${['work','gym','repair'].map(type=>{
          const cfg=this.colors[type];
          const isActive=this.state.schedule[dayIndex][type];
          return `
            <button 
              class="category-btn flex-1 py-3 font-semibold ${isActive?'':'opacity-50'}" 
              style="background:${isActive?cfg.bg:'#E5E5EA'}; color:${isActive?'white':'#8E8E93'};"
              data-category="${type}">
              ${cfg.icon} ${cfg.text}
            </button>
          `;
        }).join('')}
      </div>

      <div class="space-y-3">
        ${slots.map((slot,i)=>{
          const key = `${dayDate}-${slot.id}-${i}`;
          const isPast = this.isPast(slot, dayIndex);
          const isCurrent = this.isCurrent(slot, dayIndex);
          const isSkipped = this.state.skipped[key];

          return `
            <div class="slot p-4 ${isCurrent?'current-time':''} ${isPast?'past-slot':''} ${isSkipped?'skipped-slot':''}">
              <div class="flex justify-between">
                <div>
                  <div class="text-sm text-gray-500">${slot.t}</div>
                  <div class="font-semibold">${slot.a}</div>

                  ${slot.supps ? slot.supps.map((s,si)=>{
                    const sk = `${key}-s${si}`;
                    return `
                      <div class="flex items-center gap-2 mt-2">
                        <button 
                          class="supp-checkbox ${this.state.supplements[sk]?'checked':''}" 
                          data-supp="${sk}">
                          ${this.state.supplements[sk]?'‚úì':''}
                        </button>
                        <span class="text-sm">${s}</span>
                      </div>
                    `;
                  }).join('') : ''}
                </div>

                ${isPast ? `
                  <button class="skip-btn ${isSkipped?'skipped':''}" data-skip="${key}">
                    ${isSkipped?'–ü—Ä–æ–ø—É—â–µ–Ω–æ':'–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'}
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}
 
render(){
  const app = document.getElementById('app');
  app.innerHTML = '';

  // Tabs
  const tabs = document.createElement('div');
  tabs.className = 'flex px-4 pt-4';
  tabs.innerHTML = `
    <button class="tab-btn ${this.state.currentTab==='schedule'?'active':''}" data-tab="schedule">
      üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    </button>
    <button class="tab-btn ${this.state.currentTab==='analytics'?'active':''}" data-tab="analytics">
      üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </button>
  `;
  app.appendChild(tabs);

  tabs.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.onclick = () => {
      haptic.light();
      this.state.currentTab = btn.dataset.tab;
      this.render();
      if(this.state.currentTab === 'analytics') {
        window.scrollTo({top: 0, behavior: 'smooth'});
      }
    };
  });

  // Content
  const content = document.createElement('div');
  content.className = 'px-4 mt-4 flex-1 overflow-y-auto pb-4';

  content.innerHTML =
    this.state.currentTab === 'schedule'
      ? this.renderSchedule()
      : `${this.renderActivityRings()}${this.renderAnalytics()}`;

  app.appendChild(content);

  // Footer —Å –¥–Ω—è–º–∏ –Ω–µ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)
  if(this.state.currentTab === 'schedule'){
    const footer = document.createElement('div');
    footer.className = 'card fixed bottom-4 left-4 right-4 p-2 flex justify-between gap-1';
    this.days.forEach((d,i)=>{
      const btn = document.createElement('button');
      btn.className = `day-btn flex-1 py-2.5 ${i===this.state.selectedDay?'active':''}`;
      btn.innerText = d;
      btn.onclick = ()=>{
        haptic.light();
        this.state.selectedDay = i;
        this.render();
        this.scrollToCurrent();
      };
      footer.appendChild(btn);
    });
    app.appendChild(footer);
  }

  this.bindEvents();
  this.setupSwipe();
}
 
bindEvents(){
// Skip buttons - –ë–ï–ó –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
document.querySelectorAll('[data-skip]').forEach(btn=>{
  btn.onclick = ()=>{
    const k = btn.dataset.skip;
    this.state.skipped[k] = !this.state.skipped[k];
    this.save();
    haptic.heavy();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É –∏ —Å–ª–æ—Ç
    const isSkipped = this.state.skipped[k];
    btn.textContent = isSkipped ? '–ü—Ä–æ–ø—É—â–µ–Ω–æ' : '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å';
    btn.classList.toggle('skipped', isSkipped);
    
    const slot = btn.closest('.slot');
    if(slot) slot.classList.toggle('skipped-slot', isSkipped);
  };
});

// Supplement checkboxes - –ë–ï–ó –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
document.querySelectorAll('[data-supp]').forEach(btn=>{
  btn.onclick = ()=>{
    const k = btn.dataset.supp;
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–±–∞–≤–∫–∏
    this.state.supplements[k] = !this.state.supplements[k];

    // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏ ‚Äî –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤–∑—è—Ç—É—é
    if(this.state.suppNotifications[k]){
      this.state.suppNotifications[k].taken = this.state.supplements[k];
    }

    this.save();
    haptic.success();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ —á–µ–∫–±–æ–∫—Å
    btn.textContent = this.state.supplements[k] ? '‚úì' : '';
    btn.classList.toggle('checked', this.state.supplements[k]);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å–ø–æ—Ä—Ç–ø–∏—Ç–∞
    this.updateSuppProgress();
  };
});


  // Category buttons - –ø–æ–ª–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä (–Ω—É–∂–Ω–æ!)
document.querySelectorAll('[data-category]').forEach(btn=>{
  btn.onclick = ()=>{
    const type = btn.dataset.category;
    const dayIndex = this.state.selectedDay;
    this.state.schedule[dayIndex][type] = !this.state.schedule[dayIndex][type];
    this.save();
    haptic.medium();
    this.render(); // ‚Üê –ó–¥–µ—Å—å –ø–æ–ª–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –Ω—É–∂–µ–Ω
    this.scrollToCurrent();
  };
});
}
 
setupSwipe(){
  if(this.swipeInit) return;
  this.swipeInit = true;
  
  const app = document.getElementById('app');
  
  app.addEventListener('touchstart', e=>{
    this.touchStartX = e.touches[0].clientX;
    this.touchStartY = e.touches[0].clientY;
  }, {passive: true});
  
  app.addEventListener('touchend', e=>{
    const dx = e.changedTouches[0].clientX - this.touchStartX;
    const dy = e.changedTouches[0].clientY - this.touchStartY;
    
    // –°–≤–∞–π–ø —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    if(this.state.currentTab === 'schedule' && Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)){
      haptic.light();
      const newDay = this.state.selectedDay + (dx < 0 ? 1 : -1);
      if(newDay >= 0 && newDay <= 6){
        this.state.selectedDay = newDay;
        this.render();
        this.scrollToCurrent();
      }
    }
  });
}
 
getWeeklyStats(){
  const stats = {
    work: {total: 0, completed: 0},
    gym: {total: 0, completed: 0},
    supplements: {total: 0, completed: 0}
  };
  
  for(let i = 0; i < 7; i++){
    const dayDate = this.getDateKey(i);
    const slots = this.getSlots(i);
    
    // Work
    if(this.state.schedule[i].work){
      stats.work.total++;
      const workSlot = slots.find(s => s.id === 'work');
      if(workSlot){
        const key = `${dayDate}-${workSlot.id}-${slots.indexOf(workSlot)}`;
        if(!this.state.skipped[key] && this.isPast(workSlot, i)){
          stats.work.completed++;
        }
      }
    }
    
    // Gym
    if(this.state.schedule[i].gym){
      stats.gym.total++;
      const gymSlot = slots.find(s => s.id === 'gym');
      if(gymSlot){
        const key = `${dayDate}-${gymSlot.id}-${slots.indexOf(gymSlot)}`;
        if(!this.state.skipped[key] && this.isPast(gymSlot, i)){
          stats.gym.completed++;
        }
      }
    }
    
    // Supplements
    slots.forEach((slot, si) => {
      if(slot.supps){
        slot.supps.forEach((s, ssi) => {
          stats.supplements.total++;
          const key = `${dayDate}-${slot.id}-${si}-s${ssi}`;
          if(this.state.supplements[key]){
            stats.supplements.completed++;
          }
        });
      }
    });
  }
  
  return stats;
}

renderActivityRings(){
  const stats = this.getWeeklyStats();
  
  const workPercent = stats.work.total > 0 ? (stats.work.completed / stats.work.total) * 100 : 0;
  const gymPercent = stats.gym.total > 0 ? (stats.gym.completed / stats.gym.total) * 100 : 0;
  const suppPercent = stats.supplements.total > 0 ? (stats.supplements.completed / stats.supplements.total) * 100 : 0;
  
  const circumference = 2 * Math.PI * 70;
  
  return `
    <div class="card p-6 mb-4">
      <h2 class="text-xl font-bold mb-4" style="color:#1C1C1E;">üèÜ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</h2>
      
      <div class="flex justify-center mb-6">
        <svg width="200" height="200" viewBox="0 0 200 200">
          <!-- Work ring -->
          <circle cx="100" cy="100" r="70" fill="none" stroke="#E5E5EA" stroke-width="12"/>
          <circle class="activity-ring" cx="100" cy="100" r="70" fill="none" 
                  stroke="#FF9500" stroke-width="12" 
                  stroke-dasharray="${circumference}"
                  stroke-dashoffset="${circumference - (circumference * workPercent / 100)}"
                  transform="rotate(-90 100 100)" 
                  stroke-linecap="round"/>
          
          <!-- Gym ring -->
          <circle cx="100" cy="100" r="55" fill="none" stroke="#E5E5EA" stroke-width="12"/>
          <circle class="activity-ring" cx="100" cy="100" r="55" fill="none" 
                  stroke="#FF3B30" stroke-width="12" 
                  stroke-dasharray="${circumference * 0.785}"
                  stroke-dashoffset="${(circumference * 0.785) - (circumference * 0.785 * gymPercent / 100)}"
                  transform="rotate(-90 100 100)" 
                  stroke-linecap="round"/>
          
          <!-- Supplements ring -->
          <circle cx="100" cy="100" r="40" fill="none" stroke="#E5E5EA" stroke-width="12"/>
          <circle class="activity-ring" cx="100" cy="100" r="40" fill="none" 
                  stroke="#34C759" stroke-width="12" 
                  stroke-dasharray="${circumference * 0.571}"
                  stroke-dashoffset="${(circumference * 0.571) - (circumference * 0.571 * suppPercent / 100)}"
                  transform="rotate(-90 100 100)" 
                  stroke-linecap="round"/>
        </svg>
      </div>
      
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full" style="background:#FF9500;"></div>
            <span class="font-semibold">üíº –†–∞–±–æ—Ç–∞</span>
          </div>
          <span class="text-lg font-bold" style="color:#FF9500;">${Math.round(workPercent)}%</span>
        </div>
        
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full" style="background:#FF3B30;"></div>
            <span class="font-semibold">üèãÔ∏è –ó–∞–ª</span>
          </div>
          <span class="text-lg font-bold" style="color:#FF3B30;">${Math.round(gymPercent)}%</span>
        </div>
        
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full" style="background:#34C759;"></div>
            <span class="font-semibold">üíä –°–ø–æ—Ä—Ç–ø–∏—Ç</span>
          </div>
          <span class="text-lg font-bold" style="color:#34C759;">${Math.round(suppPercent)}%</span>
        </div>
      </div>
    </div>
  `;
}
renderSuppAnalytics(){
  const total = Object.keys(this.state.supplements).length;
  const taken = Object.values(this.state.supplements).filter(v => v).length;
  const missed = total - taken;

  return `
    <div class="card p-6 mb-4">
      <h2 class="text-xl font-bold mb-4">üíä –°–ø–æ—Ä—Ç–ø–∏—Ç</h2>
      <div class="flex justify-between items-center mb-2">
        <span>–ü—Ä–∏–Ω—è—Ç–æ</span>
        <span class="font-bold text-green-600">${taken}</span>
      </div>
      <div class="flex justify-between items-center mb-2">
        <span>–ü—Ä–æ–ø—É—â–µ–Ω–æ</span>
        <span class="font-bold text-red-500">${missed}</span>
      </div>
      <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mt-2">
        <div class="h-full rounded-full" style="width:${(taken/total)*100}%; background:#34C759;"></div>
      </div>
    </div>
  `;
}

scrollToCurrent(){
  if(this.state.currentTab !== 'schedule') return;
  
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  setTimeout(() => {
    if(this.state.selectedDay === currentDayIndex){
      const el = document.querySelector('.current-time');
      if(el){
        el.scrollIntoView({behavior: 'smooth', block: 'center'});
      }
    } else {
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
  }, 100);
}

renderAnalytics() {
  // 1Ô∏è‚É£ –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  const stats = {
    supplements: {taken: 0, missed: 0, days: {}},
    gym: {done: 0, missed: 0, days: {}},
    course: {done: 0, missed: 0, days: {}}
  };

  for (let day = 0; day < 7; day++) {
    const dayDate = this.getDateKey(day);
    const dayName = this.days[day];

    stats.supplements.days[dayName] = [];
    stats.gym.days[dayName] = [];
    stats.course.days[dayName] = [];

    const slots = this.getSlots(day);

    slots.forEach((slot, i) => {
      // –°–ø–æ—Ä—Ç–ø–∏—Ç
      if (slot.supps && this.isPast(slot, day)) {
        slot.supps.forEach((s, si) => {
          const key = `${dayDate}-${slot.id}-${i}-s${si}`;
          if (this.state.supplements[key]) {
            stats.supplements.taken++;
            stats.supplements.days[dayName].push({supp: s, status: 'taken'});
          } else {
            stats.supplements.missed++;
            stats.supplements.days[dayName].push({supp: s, status: 'missed'});
          }
        });
      }

      // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
      if (slot.id === 'gym' && this.isPast(slot, day)) {
        const key = `${dayDate}-${slot.id}-${i}`;
        if (!this.state.skipped[key]) {
          stats.gym.done++;
          stats.gym.days[dayName].push('done');
        } else {
          stats.gym.missed++;
          stats.gym.days[dayName].push('missed');
        }
      }

      // –ö—É—Ä—Å
      if (slot.id === 'course' && this.isPast(slot, day)) {
        const key = `${dayDate}-${slot.id}-${i}`;
        if (!this.state.skipped[key]) {
          stats.course.done++;
          stats.course.days[dayName].push('done');
        } else {
          stats.course.missed++;
          stats.course.days[dayName].push('missed');
        }
      }
    });
  }

  // 2Ô∏è‚É£ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–Ω–µ–π —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
  const renderDays = (category) => {
    return this.days.map(d => {
      let content = '';
      if (category === 'supplements') {
        stats.supplements.days[d].forEach(s => {
          content += `<span style="color:${s.status==='taken'?'#34C759':'#FF3B30'}; margin-right:4px;">${s.supp}</span>`;
        });
      } else if (category === 'gym') {
        stats.gym.days[d].forEach(s => {
          content += `<span style="color:${s==='done'?'#34C759':'#FF3B30'}; margin-right:4px;">${s==='done'?'‚úî':'‚úñ'}</span>`;
        });
      } else if (category === 'course') {
        stats.course.days[d].forEach(s => {
          content += `<span style="color:${s==='done'?'#007AFF':'#FF3B30'}; margin-right:4px;">${s==='done'?'‚úî':'‚úñ'}</span>`;
        });
      }
      return `<div class="flex justify-between mb-1"><span>${d}</span><span>${content}</span></div>`;
    }).join('');
  };

  // 3Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞–º–∏
  const cardTemplate = (title, done, missed, color, category) => {
    const total = done + missed;
    const percent = total ? Math.round((done / total) * 100) : 0;
    return `
      <div class="card stats-card p-4">
        <h2 class="font-bold text-lg mb-2">${title}</h2>
        <div class="flex justify-between mb-2">
          <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${done}</span>
          <span>–ü—Ä–æ–ø—É—â–µ–Ω–æ: ${missed}</span>
        </div>
        <div class="progress-bar-bg mb-2">
          <div class="progress-bar-fill" style="width: ${percent}%; background: ${color};"></div>
        </div>
        <div class="text-sm">
          ${renderDays(category)}
        </div>
      </div>
    `;
  };

  return `
    <div class="space-y-4 px-4 pb-4">
      ${cardTemplate('üíä –°–ø–æ—Ä—Ç–ø–∏—Ç', stats.supplements.taken, stats.supplements.missed, '#34C759', 'supplements')}
      ${cardTemplate('üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', stats.gym.done, stats.gym.missed, '#FF3B30', 'gym')}
      ${cardTemplate('üìö –ö—É—Ä—Å', stats.course.done, stats.course.missed, '#007AFF', 'course')}
    </div>
  `;
}

} // ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç class Planner

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', () => {
  new Planner();
});
</script>
