<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
<script src="https://cdn.tailwindcss.com"></script>

<meta name="theme-color" content="#007AFF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  * { -webkit-tap-highlight-color: transparent; }
  body { 
    overscroll-behavior: none; 
    -webkit-overflow-scrolling: touch;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
    background: #F2F2F7;
  }
  
  .card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .card:active {
    transform: scale(0.98);
  }
  
  .slot {
    background: white;
    border-radius: 14px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.04);
  }
  
  .current-time {
    background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
    color: white !important;
    box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    transform: scale(1.02);
    border: none;
  }
  
  .current-time * {
    color: white !important;
  }
  
  .past-slot {
    opacity: 0.5;
    background: #F9F9F9;
  }
  
  .skipped-slot {
    background: #FFE8E8;
    border-color: #FFD1D1;
  }
  
  .btn-primary {
    background: #007AFF;
    color: white;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,122,255,0.25);
  }
  
  .btn-primary:active {
    transform: scale(0.96);
    box-shadow: 0 1px 4px rgba(0,122,255,0.2);
  }
  
  .btn-secondary {
    background: #F2F2F7;
    color: #1C1C1E;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .btn-secondary:active {
    transform: scale(0.96);
    background: #E5E5EA;
  }
  
  .progress-bar-inner {
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(90deg, #34C759 0%, #30D158 100%);
  }
  
  .supp-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid #C7C7CC;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
  }
  
  .supp-checkbox.checked {
    background: #34C759;
    border-color: #34C759;
    color: white;
  }
  
  .skip-btn {
    background: #FF3B30;
    color: white;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(255,59,48,0.2);
  }
  
  .skip-btn:active {
    transform: scale(0.95);
  }
  
  .skip-btn.skipped {
    background: #FF9500;
  }
  
  .day-btn {
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s;
    color: #007AFF;
    background: white;
  }
  
  .day-btn.active {
    background: #007AFF;
    color: white;
    box-shadow: 0 2px 8px rgba(0,122,255,0.3);
  }
  
  .day-btn:active {
    transform: scale(0.95);
  }
  
  .category-btn {
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  
  .category-btn:active {
    transform: scale(0.96);
  }
  
  .header-title {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #1C1C1E;
  }
  
  .tab-btn {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-weight: 600;
    color: #8E8E93;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
  }
  
  .tab-btn.active {
    color: #007AFF;
    border-bottom-color: #007AFF;
  }
  
  .tab-btn:active {
    transform: scale(0.96);
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .slot {
    animation: slideIn 0.3s ease;
  }
  
  @keyframes ringGrow {
    from {
      stroke-dashoffset: 440;
    }
  }
  
  .activity-ring {
    animation: ringGrow 1s ease-out;
  }
  
  .notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: white;
    border-radius: 16px;
    padding: 16px 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    z-index: 1000;
    min-width: 300px;
    animation: slideDown 0.4s ease-out forwards;
  }
  
  @keyframes slideDown {
    to {
      transform: translateX(-50%) translateY(0);
    }
  }
  
  .notification.hide {
    animation: slideUp 0.4s ease-out forwards;
  }
  
  @keyframes slideUp {
    to {
      transform: translateX(-50%) translateY(-100px);
      opacity: 0;
    }
  }
  
  .trend-up {
    color: #34C759;
  }
  
  .trend-down {
    color: #FF3B30;
  }
  
  .chart-bar {
    transition: height 0.5s ease-out;
  }
</style>
</head>

<body class="flex flex-col min-h-screen">
<div id="notification-container"></div>
<div id="app" class="flex-1 flex flex-col overflow-hidden pb-20"></div>

<script>
const storage = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
};

// Haptic feedback helper
const haptic = {
  light: () => {
    if (navigator.vibrate) navigator.vibrate(10);
  },
  medium: () => {
    if (navigator.vibrate) navigator.vibrate(20);
  },
  heavy: () => {
    if (navigator.vibrate) navigator.vibrate(30);
  },
  success: () => {
    if (navigator.vibrate) navigator.vibrate([10, 50, 10]);
  }
};

class Planner {
constructor(){
  const today=new Date();
  this.days=['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
  this.state={
    selectedDay: today.getDay()===0?6:today.getDay()-1,
    currentTab: 'schedule',
    schedule: storage.get('schedule') || {
      0:{work:true,gym:true,repair:true},
      1:{work:false,gym:false,repair:true},
      2:{work:true,gym:true,repair:true},
      3:{work:false,gym:false,repair:true},
      4:{work:true,gym:true,repair:true},
      5:{work:false,gym:false,repair:true},
      6:{work:false,gym:true,repair:true}
    },
    skipped: storage.get('skipped') ?? {},
    supplements: storage.get('supplements') ?? {},
    notifications: storage.get('notifications') || true,
    lastNotification: storage.get('lastNotification') || null
  };

  this.colors={
    work:{bg:'#FF9500',text:'–†–∞–±–æ—Ç–∞',icon:'üíº'},
    gym:{bg:'#FF3B30',text:'–ó–∞–ª',icon:'üèãÔ∏è'},
    repair:{bg:'#FFCC00',text:'–†–µ–º–æ–Ω—Ç',icon:'üî®'}
  };
  this.slotsElements={};
  this.swipeInit=false;
  this.touchStartX=0;
  this.touchStartY=0;

  this.render();
  this.scrollToCurrent();
  
  setInterval(()=>{
    this.render();
    this.checkNotifications();
  }, 60000);
  
  this.checkNotifications();
}

save(){
  storage.set('schedule',this.state.schedule);
  storage.set('skipped',this.state.skipped);
  storage.set('supplements',this.state.supplements);
  storage.set('notifications',this.state.notifications);
  storage.set('lastNotification',this.state.lastNotification);
}

getDateForDay(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  const months=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞—è','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return `${m.getDate()} ${months[m.getMonth()]}`;
}

getDateKey(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  return m.toISOString().split('T')[0];
}

toMin(t){
  const[h,m]=t.split(':').map(Number);
  return h*60+m;
}

checkNotifications(){
  if(!this.state.notifications) return;
  
  const now = new Date();
  const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1;
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const slots = this.getSlots(currentDayIndex);
  
  slots.forEach((slot, i) => {
    if(!slot.t.includes('-')) return;
    
    const [startTime] = slot.t.split('-');
    const [startH, startM] = startTime.split(':').map(Number);
    let startMinutes = startH * 60 + startM;
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 10 –º–∏–Ω—É—Ç
    const notifyTime = startMinutes - 10;
    const notifyKey = `${this.getDateKey(currentDayIndex)}-${slot.id}-${i}`;
    
    if(Math.abs(currentMinutes - notifyTime) < 1 && this.state.lastNotification !== notifyKey){
      this.showNotification(`–ß–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç: ${slot.a}`, slot.supps);
      this.state.lastNotification = notifyKey;
      this.save();
    }
  });
}

showNotification(text, supps){
  haptic.medium();
  
  const container = document.getElementById('notification-container');
  const notif = document.createElement('div');
  notif.className = 'notification';
  
  let suppHtml = '';
  if(supps && supps.length > 0){
    suppHtml = `<div class="mt-2 text-sm text-gray-600">üíä ${supps.join(', ')}</div>`;
  }
  
  notif.innerHTML = `
    <div class="flex items-start gap-3">
      <div class="text-2xl">‚è∞</div>
      <div class="flex-1">
        <div class="font-semibold text-gray-900">${text}</div>
        ${suppHtml}
      </div>
    </div>
  `;
  
  container.appendChild(notif);
  
  setTimeout(() => {
    notif.classList.add('hide');
    setTimeout(() => notif.remove(), 400);
  }, 5000);
}

isPast(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex < currentDayIndex) return true;
  if(dayIndex > currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH, endM] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  let endMinutes = endH * 60 + endM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return false;
    }
    return currentMinutes >= endMinutes;
  }
  
  if(endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }
  
  return currentMinutes >= endMinutes;
}

isFuture(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex > currentDayIndex) return true;
  if(dayIndex < currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return true;
    }
    return currentMinutes < startMinutes;
  }
  
  return currentMinutes < startMinutes;
}

isCurrent(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex !== currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH, endM] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  let endMinutes = endH * 60 + endM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return false;
    }
    return currentMinutes >= startMinutes && currentMinutes < endMinutes;
  }
  
  if(endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }
  
  return currentMinutes >= startMinutes && currentMinutes < endMinutes;
}

getSlots(dayIndex){
  const {work,gym,repair}=this.state.schedule[dayIndex];
  const s=[];
  if(work){
    s.push(
      {t:'06:00-06:20',a:'–ü–æ–¥—ä–µ–º',c:'bg-orange-50',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'06:20-06:30',a:'–°–±–æ—Ä—ã',c:'bg-orange-100',id:'prep'},
      {t:'06:30-07:00',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-50',id:'commute1'},
      {t:'07:00-15:00',a:'–†–∞–±–æ—Ç–∞',c:'bg-orange-100',id:'work',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']},
      {t:'15:00-15:30',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-50',id:'commute2'},
      {t:'15:30-16:00',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'}
    );
    s.push(repair
      ?{t:'16:00-19:00',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-50',id:'repair'}
      :{t:'16:00-19:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free1'}
    );
  } else {
    s.push(
      {t:'06:00-09:00',a:'–°–æ–Ω +3—á',c:'bg-indigo-50',id:'sleep2'},
      {t:'09:00-09:30',a:'–ü–æ–¥—ä–µ–º',c:'bg-indigo-100',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'09:30-10:30',a:'–ó–∞–≤—Ç—Ä–∞–∫',c:'bg-green-50',id:'breakfast',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']}
    );
    if(repair){
      s.push(
        {t:'10:30-13:30',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-50',id:'repair1'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'},
        {t:'14:30-18:30',a:'–†–µ–º–æ–Ω—Ç 4—á',c:'bg-yellow-100',id:'repair2'}
      );
    } else {
      s.push(
        {t:'10:30-13:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free2'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'},
        {t:'14:30-18:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free3'}
      );
    }
  }
  if(gym){
    s.push(
      {t:'19:00-19:30',a:'–ö –∑–∞–ª—É',c:'bg-red-50',id:'gym1',supps:['–ë–µ—Ç–∞-–∞–ª–∞–Ω–∏–Ω','–¶–∏—Ç—Ä—É–ª–∏–Ω']},
      {t:'19:30-21:00',a:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',c:'bg-red-100',id:'gym'},
      {t:'21:00-21:30',a:'–û—Ç –∑–∞–ª–∞',c:'bg-red-50',id:'gym2',supps:['–ö—Ä–µ–∞—Ç–∏–Ω','–ì–µ–π–Ω–µ—Ä']},
      {t:'21:30-22:30',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
      {t:'22:30-23:30',a:'–ö—É—Ä—Å',c:'bg-purple-50',id:'course'},
      {t:'23:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
    );
  } else {
    if(work){
      s.push(
        {t:'19:00-20:00',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
        {t:'20:00-22:00',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-100',id:'course'},
        {t:'22:00-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    } else {
      s.push(
        {t:'18:30-19:30',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
        {t:'19:30-21:30',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-100',id:'course'},
        {t:'21:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    }
  }
  s.push({t:'00:00-06:00',a:'–°–æ–Ω',c:'bg-indigo-100',id:'sleep'});
  return s;
}
 
renderDailySuppStats(dayIndex){
  const dayDate=this.getDateKey(dayIndex);
  const slots=this.getSlots(dayIndex);

  let total=0, taken=0;
  slots.forEach((slot,i)=>{
    if(slot.supps){
      slot.supps.forEach((s,si)=>{
        total++;
        const sk=`${dayDate}-${slot.id}-${i}-s${si}`;
        if(this.state.supplements[sk]) taken++;
      });
    }
  });

  if(total===0) return '';

  const percent=Math.round((taken/total)*100);

  return `
    <div class="card p-4 mb-4">
      <div class="flex justify-between items-center mb-2">
        <span class="text-base font-semibold" style="color:#1C1C1E;">üíä –°–ø–æ—Ä—Ç–ø–∏—Ç</span>
        <span class="progress-percent text-2xl font-bold" style="color:#34C759;">${percent}%</span>
      </div>
      <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden">
        <div class="progress-bar-inner h-full rounded-full" style="width:${percent}%"></div>
      </div>
      <div class="mt-2 text-xs text-gray-500">${taken} –∏–∑ ${total} –ø—Ä–∏–Ω—è—Ç—ã</div>
    </div>
  `;
}
 
renderSchedule(){
  this.slotsElements = {};
  const dayIndex = this.state.selectedDay;
  const dayDate = this.getDateKey(dayIndex);
  const slots = this.getSlots(dayIndex);

  return `
    <div>
      <div class="mb-4">
        <h1 class="header-title">${this.days[dayIndex]}</h1>
        <p class="text-gray-500">${this.getDateForDay(dayIndex)}</p>
      </div>

      ${this.renderDailySuppStats(dayIndex)}

      <div class="flex gap-2 mb-4">
        ${['work','gym','repair'].map(type=>{
          const cfg=this.colors[type];
          const isActive=this.state.schedule[dayIndex][type];
          return `
            <button 
              class="category-btn flex-1 py-3 font-semibold ${isActive?'':'opacity-50'}" 
              style="background:${isActive?cfg.bg:'#E5E5EA'}; color:${isActive?'white':'#8E8E93'};"
              data-category="${type}">
              ${cfg.icon} ${cfg.text}
            </button>
          `;
        }).join('')}
      </div>

      <div class="space-y-3">
        ${slots.map((slot,i)=>{
          const key = `${dayDate}-${slot.id}-${i}`;
          const isPast = this.isPast(slot, dayIndex);
          const isCurrent = this.isCurrent(slot, dayIndex);
          const isSkipped = this.state.skipped[key];

          return `
            <div class="slot p-4 ${isCurrent?'current-time':''} ${isPast?'past-slot':''} ${isSkipped?'skipped-slot':''}">
              <div class="flex justify-between">
                <div>
                  <div class="text-sm text-gray-500">${slot.t}</div>
                  <div class="font-semibold">${slot.a}</div>

                  ${slot.supps ? slot.supps.map((s,si)=>{
                    const sk = `${key}-s${si}`;
                    return `
                      <div class="flex items-center gap-2 mt-2">
                        <button 
                          class="supp-checkbox ${this.state.supplements[sk]?'checked':''}" 
                          data-supp="${sk}">
                          ${this.state.supplements[sk]?'‚úì':''}
                        </button>
                        <span class="text-sm">${s}</span>
                      </div>
                    `;
                  }).join('') : ''}
                </div>

                ${isPast ? `
                  <button class="skip-btn ${isSkipped?'skipped':''}" data-skip="${key}">
                    ${isSkipped?'–ü—Ä–æ–ø—É—â–µ–Ω–æ':'–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'}
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}
 
render(){
  const app = document.getElementById('app');
  app.innerHTML = '';

  // Tabs
  const tabs = document.createElement('div');
  tabs.className = 'flex px-4 pt-4';
  tabs.innerHTML = `
    <button class="tab-btn ${this.state.currentTab==='schedule'?'active':''}" data-tab="schedule">
      üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    </button>
    <button class="tab-btn ${this.state.currentTab==='analytics'?'active':''}" data-tab="analytics">
      üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </button>
  `;
  app.appendChild(tabs);

  tabs.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.onclick = () => {
      haptic.light();
      this.state.currentTab = btn.dataset.tab;
      this.render();
      if(this.state.currentTab === 'analytics') {
        window.scrollTo({top: 0, behavior: 'smooth'});
      }
    };
  });

  // Content
  const content = document.createElement('div');
  content.className = 'px-4 mt-4 flex-1 overflow-y-auto pb-4';

  content.innerHTML =
    this.state.currentTab === 'schedule'
      ? this.renderSchedule()
      : `${this.renderActivityRings()}${this.renderAnalytics()}`;

  app.appendChild(content);

  // Footer —Å –¥–Ω—è–º–∏ –Ω–µ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)
  if(this.state.currentTab === 'schedule'){
    const footer = document.createElement('div');
    footer.className = 'card fixed bottom-4 left-4 right-4 p-2 flex justify-between gap-1';
    this.days.forEach((d,i)=>{
      const btn = document.createElement('button');
      btn.className = `day-btn flex-1 py-2.5 ${i===this.state.selectedDay?'active':''}`;
      btn.innerText = d;
      btn.onclick = ()=>{
        haptic.light();
        this.state.selectedDay = i;
        this.render();
        this.scrollToCurrent();
      };
      footer.appendChild(btn);
    });
    app.appendChild(footer);
  }

  this.bindEvents();
  this.setupSwipe();
}
 
bindEvents(){
  // Skip buttons
  document.querySelectorAll('[data-skip]').forEach(btn=>{
    btn.onclick = ()=>{
      const k = btn.dataset.skip;
      this.state.skipped[k] = !this.state.skipped[k];
      this.save();
      haptic.heavy();
      this.render();
    };
  });

  // Supplement checkboxes
  document.querySelectorAll('[data-supp]').forEach(btn=>{
    btn.onclick = ()=>{
      const k = btn.dataset.supp;
      this.state.supplements[k] = !this.state.supplements[k];
      this.save();
      haptic.success();
      this.render();
    };
  });

  // Category buttons
  document.querySelectorAll('[data-category]').forEach(btn=>{
    btn.onclick = ()=>{
      const type = btn.dataset.category;
      const dayIndex = this.state.selectedDay;
      this.state.schedule[dayIndex][type] = !this.state.schedule[dayIndex][type];
      this.save();
      haptic.medium();
      this.render();
      this.scrollToCurrent();
    };
  });
}
 
setupSwipe(){
  if(this.swipeInit) return;
  this.swipeInit = true;
  
  const app = document.getElementById('app');
  
  app.addEventListener('touchstart', e=>{
    this.touchStartX = e.touches[0].clientX;
    this.touchStartY = e.touches[0].clientY;
  }, {passive: true});
  
  app.addEventListener('touchend', e=>{
    const dx = e.changedTouches[0].clientX - this.touchStartX;
    const dy = e.changedTouches[0].clientY - this.touchStartY;
    
    // –°–≤–∞–π–ø —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    if(this.state.currentTab === 'schedule' && Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)){
      haptic.light();
      const newDay = this.state.selectedDay + (dx < 0 ? 1 : -1);
      if(newDay >= 0 && newDay <= 6){
        this.state.selectedDay = newDay;
        this.render();
        this.scrollToCurrent();
      }
    }
  });
}
 
getWeeklyStats(){
  const stats = {
    work: {total: 0, completed: 0},
    gym: {total: 0, completed: 0},
    supplements: {total: 0, completed: 0}
  };
  
  for(let i = 0; i < 7; i++){
    const dayDate = this.getDateKey(i);
    const slots = this.getSlots(i);
    
    // Work
    if(this.state.schedule[i].work){
      stats.work.total++;
      const workSlot = slots.find(s => s.id === 'work');
      if(workSlot){
        const key = `${dayDate}-${workSlot.id}-${slots.indexOf(workSlot)}`;
        if(!this.state.skipped[key] && this.isPast(workSlot, i)){
          stats.work.completed++;
        }
      }
    }
    
    // Gym
    if(this.state.schedule[i].gym){
      stats.gym.total++;
      const gymSlot = slots.find(s => s.id === 'gym');
      if(gymSlot){
        const key = `${dayDate}-${gymSlot.id}-${slots.indexOf(gymSlot)}`;
        if(!this.state.skipped[key] && this.isPast(gymSlot, i)){
          stats.gym.completed++;
        }
      }
    }
    
    // Supplements
    slots.forEach((slot, si) => {
      if(slot.supps){
        slot.supps.forEach((s, ssi) => {
          stats.supplements.total++;
          const key = `${dayDate}-${slot.id}-${si}-s${ssi}`;
          if(this.state.supplements[key]){
            stats.supplements.completed++;
          }
        });
      }
    });
  }
  
  return stats;
}

renderActivityRings(){
  const stats = this.getWeeklyStats();
  
  const workPercent = stats.work.total > 0 ? (stats.work.completed / stats.work.total) * 100 : 0;
  const gymPercent = stats.gym.total > 0 ? (stats.gym.completed / stats.gym.total) * 100 : 0;
  const suppPercent = stats.supplements.total > 0 ? (stats.supplements.completed / stats.supplements.total) * 100 : 0;
  
  const circumference = 2 * Math.PI * 70;
  
  return `
    <div class="card p-6 mb-4">
      <h2 class="text-xl font-bold mb-4" style="color:#1C1C1E;">üèÜ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</h2>
      
      <div class="flex justify-center mb-6">
        <svg width="200" height="200" viewBox="0 0 200 200">
          <!-- Work ring -->
          <circle cx="100" cy="100" r="70" fill="none" stroke="#E5E5EA" stroke-width="12"/>
          <circle class="activity-ring" cx="100" cy="100" r="70" fill="none" 
                  stroke="#FF9500" stroke-width="12" 
                  stroke-dasharray="${circumference}"
                  stroke-dashoffset="${circumference - (circumference * workPercent / 100)}"
                  transform="rotate(-90 100 100)" 
                  stroke-linecap="round"/>
          
          <!-- Gym ring -->
          <circle cx="100" cy="100" r="55" fill="none" stroke="#E5E5EA" stroke-width="12"/>
          <circle class="activity-ring" cx="100" cy="100" r="55" fill="none" 
                  stroke="#FF3B30" stroke-width="12" 
                  stroke-dasharray="${circumference * 0.785}"
                  stroke-dashoffset="${(circumference * 0.785) - (circumference * 0.785 * gymPercent / 100)}"
                  transform="rotate(-90 100 100)" 
                  stroke-linecap="round"/>
          
          <!-- Supplements ring -->
          <circle cx="100" cy="100" r="40" fill="none" stroke="#E5E5EA" stroke-width="12"/>
          <circle class="activity-ring" cx="100" cy="100" r="40" fill="none" 
                  stroke="#34C759" stroke-width="12" 
                  stroke-dasharray="${circumference * 0.571}"
                  stroke-dashoffset="${(circumference * 0.571) - (circumference * 0.571 * suppPercent / 100)}"
                  transform="rotate(-90 100 100)" 
                  stroke-linecap="round"/>
        </svg>
      </div>
      
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full" style="background:#FF9500;"></div>
            <span class="font-semibold">üíº –†–∞–±–æ—Ç–∞</span>
          </div>
          <span class="text-lg font-bold" style="color:#FF9500;">${Math.round(workPercent)}%</span>
        </div>
        
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full" style="background:#FF3B30;"></div>
            <span class="font-semibold">üèãÔ∏è –ó–∞–ª</span>
          </div>
          <span class="text-lg font-bold" style="color:#FF3B30;">${Math.round(gymPercent)}%</span>
        </div>
        
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full" style="background:#34C759;"></div>
            <span class="font-semibold">üíä –°–ø–æ—Ä—Ç–ø–∏—Ç</span>
          </div>
          <span class="text-lg font-bold" style="color:#34C759;">${Math.round(suppPercent)}%</span>
        </div>
      </div>
    </div>
  `;
}
 
scrollToCurrent(){
  if(this.state.currentTab !== 'schedule') return;
  
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  setTimeout(() => {
    if(this.state.selectedDay === currentDayIndex){
      const el = document.querySelector('.current-time');
      if(el){
        el.scrollIntoView({behavior: 'smooth', block: 'center'});
      }
    } else {
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
  }, 100);
}

renderAnalytics(){
  const stats = this.getWeeklyStats();
  
  // –¢—Ä–µ–Ω–¥ –ø–æ –¥–Ω—è–º
  const dailyGym = [];
  for(let i = 0; i < 7; i++){
    const dayDate = this.getDateKey(i);
    const slots = this.getSlots(i);
    const gymSlot = slots.find(s => s.id === 'gym');
    
    let status = 0; // 0 - –Ω–µ –±—ã–ª–æ, 1 - –ø—Ä–æ–ø—É—â–µ–Ω–æ, 2 - –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
    if(this.state.schedule[i].gym && gymSlot){
      const key = `${dayDate}-${gymSlot.id}-${slots.indexOf(gymSlot)}`;
      if(this.isPast(gymSlot, i)){
        status = this.state.skipped[key] ? 1 : 2;
      }
    }
    
    dailyGym.push({day: this.days[i], status});
  }
  
  const maxHeight = 80;
  
  return `
    <div class="card p-6 mb-4">
      <h2 class="text-xl font-bold mb-4" style="color:#1C1C1E;">üìä –¢—Ä–µ–Ω–¥—ã</h2>
      
      <div class="mb-6">
        <p class="text-sm text-gray-600 mb-3">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –∑–∞–ª–∞</p>
        <div class="flex items-end justify-between gap-2" style="height:100px;">
          ${dailyGym.map(d => {
            const height = d.status === 2 ? maxHeight : (d.status === 1 ? maxHeight * 0.3 : 10);
            const color = d.status === 2 ? '#34C759' : (d.status === 1 ? '#FF3B30' : '#E5E5EA');
            return `
              <div class="flex-1 flex flex-col items-center gap-1">
                <div class="chart-bar w-full rounded-t-lg transition-all" 
                     style="height:${height}px; background:${color};"></div>
                <span class="text-xs text-gray-500">${d.day}</span>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <div class="flex gap-2 text-xs">
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#34C759;"></div>
          <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#FF3B30;"></div>
          <span>–ü—Ä–æ–ø—É—â–µ–Ω–æ</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#E5E5EA;"></div>
          <span>–ù–µ –±—ã–ª–æ</span>
        </div>
      </div>
    </div>
    
    <div class="card p-6 mb-4">
      <h2 class="text-xl font-bold mb-4" style="color:#1C1C1E;">üí° Insights</h2>
      
      <div class="space-y-3">
        ${stats.gym.completed > 0 ? `
          <div class="p-4 rounded-xl" style="background:#F0FDF4;">
            <p class="text-sm">
              <span class="font-bold trend-up">–û—Ç–ª–∏—á–Ω–æ!</span> 
              –¢—ã —Å—Ö–æ–¥–∏–ª –≤ –∑–∞–ª <span class="font-bold">${stats.gym.completed}</span> —Ä–∞–∑ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
            </p>
          </div>
        ` : ''}
        
        ${stats.supplements.completed > stats.supplements.total * 0.8 ? `
          <div class="p-4 rounded-xl" style="background:#F0F9FF;">
            <p class="text-sm">
              <span class="font-bold" style="color:#007AFF;">–ú–æ–ª–æ–¥–µ—Ü!</span> 
              –†–µ–≥—É–ª—è—Ä–Ω—ã–π –ø—Ä–∏–µ–º —Å–ø–æ—Ä—Ç–ø–∏—Ç–∞ –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å—É
            </p>
          </div>
        ` : ''}
        
        ${stats.work.completed === stats.work.total && stats.work.total > 0 ? `
          <div class="p-4 rounded-xl" style="background:#FFF7ED;">
            <p class="text-sm">
              <span class="font-bold" style="color:#FF9500;">üí™ –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 100%!</span> 
              –¢—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
            </p>
          </div>
        ` : ''}
      </div>
    </div>
    `;
} // ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç renderAnalytics()

} // ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç class Planner

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', () => {
  new Planner();
});
</script>
</body>
</html>
