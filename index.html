<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
<script src="https://cdn.tailwindcss.com"></script>

<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
  .current-time {
    border-left-width: 4px;
    border-left-color: #3b82f6;
    animation: pulse 2s ease-in-out infinite;
    box-shadow: 0 0 0 4px rgba(59,130,246,.1);
  }
  @keyframes pulse {
    50% {
      border-left-color: #2563eb;
      box-shadow: 0 0 0 8px rgba(59,130,246,.2);
    }
  }
  .slot { transition: background .3s, border-left .3s; }
</style>
</head>

<body class="bg-gray-50 flex flex-col min-h-screen">
<div id="app" class="flex-1 flex flex-col overflow-hidden"></div>

<script>
/* ================== STORAGE ================== */
const storage={
  get:k=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};

/* ================== PLANNER ================== */
class Planner{
constructor(){
  const today=new Date();
  this.days=['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];

  this.state={
    selectedDay:today.getDay()===0?6:today.getDay()-1,
    schedule:storage.get('schedule')||{
      0:{work:true,gym:true,repair:true},
      1:{work:false,gym:false,repair:true},
      2:{work:true,gym:true,repair:true},
      3:{work:false,gym:false,repair:true},
      4:{work:true,gym:true,repair:true},
      5:{work:false,gym:false,repair:true},
      6:{work:false,gym:true,repair:true}
    },
    completed:storage.get('completed')||{},
    supplements:storage.get('supplements')||{},
    showStats:true
  };

  this.colors={work:'orange',gym:'red',repair:'yellow'};
  this.slotsElements={};
  this.swipeInit=false;
  this.touchStartX=0;
  this.touchStartY=0;

  this.render();
  this.scrollToCurrent();
}

/* ================== UTILS ================== */
save(){
  storage.set('schedule',this.state.schedule);
  storage.set('completed',this.state.completed);
  storage.set('supplements',this.state.supplements);
}

getDateForDay(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  return m.toISOString().split('T')[0];
}

toMin(t){
  const[h,m]=t.split(':').map(Number);
  return h*60+m;
}

isCurrent(slot){
  if(!slot.t.includes('-')) return false;
  const now=new Date();
  let cur=this.toMin(`${now.getHours()}:${now.getMinutes()}`);
  let [s,e]=slot.t.split('-').map(this.toMin);
  if(e<=s) e+=1440;
  if(cur<s) cur+=1440;
  return cur>=s&&cur<e;
}

/* ================== SLOTS ================== */
getSlots(dayIndex){
  const {work,gym,repair}=this.state.schedule[dayIndex];
  const s=[];

  if(work){
    s.push(
      {t:'06:00-06:20',a:'–ü–æ–¥—ä–µ–º',c:'bg-orange-100',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'06:20-06:30',a:'–°–±–æ—Ä—ã',c:'bg-orange-200',id:'prep'},
      {t:'06:30-07:00',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-100',id:'commute1'},
      {t:'07:00-15:00',a:'–†–∞–±–æ—Ç–∞',c:'bg-orange-300',id:'work',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']},
      {t:'15:00-15:30',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-100',id:'commute2'},
      {t:'15:30-16:00',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'}
    );
    s.push(repair
      ?{t:'16:00-19:00',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-200',id:'repair'}
      :{t:'16:00-19:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-100',id:'free1'}
    );
  }else{
    s.push(
      {t:'09:00-09:30',a:'–ü–æ–¥—ä–µ–º',c:'bg-indigo-200',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'09:30-10:30',a:'–ó–∞–≤—Ç—Ä–∞–∫',c:'bg-green-200',id:'breakfast',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']}
    );
    s.push(repair
      ?{t:'10:30-13:30',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-200',id:'repair1'}
      :{t:'10:30-13:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-100',id:'free2'}
    );
    s.push(
      {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'}
    );
    s.push(repair
      ?{t:'14:30-18:30',a:'–†–µ–º–æ–Ω—Ç 4—á',c:'bg-yellow-300',id:'repair2'}
      :{t:'14:30-18:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free3'}
    );
  }

  if(gym){
    s.push(
      {t:'19:00-19:30',a:'–ö –∑–∞–ª—É',c:'bg-red-100',id:'gym1',supps:['–ë–µ—Ç–∞-–∞–ª–∞–Ω–∏–Ω','–¶–∏—Ç—Ä—É–ª–∏–Ω']},
      {t:'19:30-21:00',a:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',c:'bg-red-300',id:'gym'},
      {t:'21:00-21:30',a:'–û—Ç –∑–∞–ª–∞',c:'bg-red-100',id:'gym2',supps:['–ö—Ä–µ–∞—Ç–∏–Ω','–ì–µ–π–Ω–µ—Ä']}
    );
  }

  s.push(
    {t:'21:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']},
    {t:'00:00-06:00',a:'–°–æ–Ω',c:'bg-indigo-300',id:'sleep'}
  );

  return s;
}

/* ================== RENDER ================== */
render(){
  this.slotsElements={};

  const d=this.state.selectedDay;
  const date=this.getDateForDay(d);
  const slots=this.getSlots(d);
  const app=document.getElementById('app');
  app.innerHTML='';

  /* HEADER */
  const header=document.createElement('div');
  header.className='p-4';
  header.innerHTML=`<h1 class="text-xl font-bold mb-2">üìÖ ${this.days[d]} ${date}</h1>`;
  app.appendChild(header);

  /* OPTIONS */
  const opts=document.createElement('div');
  opts.className='flex gap-2 mb-4 px-4';
  ['work','gym','repair'].forEach(type=>{
    const b=document.createElement('button');
    b.className=`flex-1 py-2 rounded text-white ${this.state.schedule[d][type]?`bg-${this.colors[type]}-500`:'bg-gray-400'}`;
    b.textContent=type==='work'?'–†–∞–±–æ—Ç–∞':type==='gym'?'–ó–∞–ª':'–†–µ–º–æ–Ω—Ç';
    b.onclick=()=>{
      this.state.schedule[d][type]=!this.state.schedule[d][type];
      this.save();
      this.render();
      this.scrollToCurrent();
    };
    opts.appendChild(b);
  });
  app.appendChild(opts);

  /* SLOTS */
  const list=document.createElement('div');
  list.className='flex-1 overflow-y-auto px-4';

  slots.forEach((slot,i)=>{
    const key=`${date}-${slot.id}-${i}`;
    const div=document.createElement('div');
    div.className=`slot p-3 mb-2 rounded ${slot.c} ${this.isCurrent(slot)?'current-time':''}`;

    const done=this.state.completed[key];
    let suppHtml='';

    if(slot.supps){
      suppHtml='<div class="mt-1 pt-1 border-t border-teal-300 bg-teal-50 px-2 py-1 rounded">';
      slot.supps.forEach((s,si)=>{
        const sk=`${key}-s${si}`;
        const taken=this.state.supplements[sk];
        suppHtml+=`
          <div class="flex items-center gap-2 mb-0.5">
            <button class="supp-btn w-4 h-4 border rounded ${taken?'bg-green-500':'border-gray-400'}" data-key="${sk}">${taken?'‚úì':''}</button>
            <span class="text-xs ${taken?'line-through text-gray-500':'text-teal-700'}">üíä ${s}</span>
          </div>`;
      });
      suppHtml+='</div>';
    }

    div.innerHTML=`
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold">${slot.t}</div>
          <div>${slot.a}</div>
          ${suppHtml}
        </div>
        <button class="task-btn w-6 h-6 border-2 rounded ${done?'bg-green-500':'border-gray-400'}">${done?'‚úì':''}</button>
      </div>`;

    div.querySelector('.task-btn').onclick=()=>{
      this.state.completed[key]=!this.state.completed[key];
      this.save();
      this.updateSlot(div,key);
    };

    div.querySelectorAll('.supp-btn').forEach(b=>{
      b.onclick=()=>{
        const k=b.dataset.key;
        this.state.supplements[k]=!this.state.supplements[k];
        this.save();
        this.updateSupp(b,k);
      };
    });

    list.appendChild(div);
    this.slotsElements[key]=div;
  });

  app.appendChild(list);

  /* FOOTER */
  const footer=document.createElement('div');
  footer.className='bg-white border-t flex p-2';
  this.days.forEach((name,i)=>{
    const b=document.createElement('button');
    b.className=`flex-1 py-2 mx-1 rounded ${i===d?'bg-blue-500 text-white':'bg-gray-200'}`;
    b.textContent=name;
    b.onclick=()=>{this.state.selectedDay=i;this.render();this.scrollToCurrent();}
    footer.appendChild(b);
  });
  app.appendChild(footer);

  this.setupSwipe();
}

/* ================== UPDATES ================== */
updateSlot(div,key){
  const d=this.state.completed[key];
  const b=div.querySelector('.task-btn');
  b.className=`task-btn w-6 h-6 border-2 rounded ${d?'bg-green-500':'border-gray-400'}`;
  b.textContent=d?'‚úì':'';
  div.classList.toggle('opacity-80',d);
}

updateSupp(btn,key){
  const t=this.state.supplements[key];
  btn.className=`supp-btn w-4 h-4 border rounded ${t?'bg-green-500':'border-gray-400'}`;
  btn.textContent=t?'‚úì':'';
  const l=btn.nextElementSibling;
  if(l) l.className=`text-xs ${t?'line-through text-gray-500':'text-teal-700'}`;
}

/* ================== SWIPE ================== */
setupSwipe(){
  if(this.swipeInit) return;
  this.swipeInit=true;
  const app=document.getElementById('app');

  app.addEventListener('touchstart',e=>{
    this.touchStartX=e.touches[0].clientX;
    this.touchStartY=e.touches[0].clientY;
  });

  app.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-this.touchStartX;
    const dy=e.changedTouches[0].clientY-this.touchStartY;
    if(Math.abs(dx)>50&&Math.abs(dx)>Math.abs(dy)){
      this.state.selectedDay=Math.min(6,Math.max(0,this.state.selectedDay+(dx<0?1:-1)));
      this.render();
      this.scrollToCurrent();
    }
  });
}

/* ================== SCROLL ================== */
scrollToCurrent(){
  Object.values(this.slotsElements).find(e=>{
    if(e.classList.contains('current-time')){
      e.scrollIntoView({behavior:'smooth',block:'center'});
      return true;
    }
  });
}
}

/* ================== START ================== */
new Planner();
</script>
</body>
</html>
