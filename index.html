<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
<script src="https://cdn.tailwindcss.com"></script>

<meta name="theme-color" content="#007AFF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  * { -webkit-tap-highlight-color: transparent; }
  body { 
    overscroll-behavior: none; 
    -webkit-overflow-scrolling: touch;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
    background: #F2F2F7;
  }
  
  .card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .card:active {
    transform: scale(0.98);
  }
  
  .slot {
    background: white;
    border-radius: 14px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.04);
  }
  
  .current-time {
    background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
    color: white !important;
    box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    transform: scale(1.02);
    border: none;
  }
  
  .current-time * {
    color: white !important;
  }
  
  .past-slot {
    opacity: 0.5;
    background: #F9F9F9;
  }
  
  .skipped-slot {
    background: #FFE8E8;
    border-color: #FFD1D1;
  }
  
  .btn-primary {
    background: #007AFF;
    color: white;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,122,255,0.25);
  }
  
  .btn-primary:active {
    transform: scale(0.96);
    box-shadow: 0 1px 4px rgba(0,122,255,0.2);
  }
  
  .btn-secondary {
    background: #F2F2F7;
    color: #1C1C1E;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .btn-secondary:active {
    transform: scale(0.96);
    background: #E5E5EA;
  }
  
  .progress-bar-inner {
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(90deg, #34C759 0%, #30D158 100%);
  }
  
  .supp-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid #C7C7CC;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
  }
  
  .supp-checkbox.checked {
    background: #34C759;
    border-color: #34C759;
    color: white;
  }
  
  .skip-btn {
    background: #FF3B30;
    color: white;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(255,59,48,0.2);
  }
  
  .skip-btn:active {
    transform: scale(0.95);
  }
  
  .skip-btn.skipped {
    background: #FF9500;
  }
  
  .day-btn {
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s;
    color: #007AFF;
    background: white;
  }
  
  .day-btn.active {
    background: #007AFF;
    color: white;
    box-shadow: 0 2px 8px rgba(0,122,255,0.3);
  }
  
  .day-btn:active {
    transform: scale(0.95);
  }
  
  .category-btn {
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  
  .category-btn:active {
    transform: scale(0.96);
  }
  
  .header-title {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #1C1C1E;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .slot {
    animation: slideIn 0.3s ease;
  }
</style>
</head>

<body class="flex flex-col min-h-screen">
<div id="app" class="flex-1 flex flex-col overflow-hidden pb-20"></div>

<script>
const storage = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
};

class Planner {
constructor(){
  const today=new Date();
  this.days=['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
  this.state={
    selectedDay: today.getDay()===0?6:today.getDay()-1,
    schedule: storage.get('schedule') || {
      0:{work:true,gym:true,repair:true},
      1:{work:false,gym:false,repair:true},
      2:{work:true,gym:true,repair:true},
      3:{work:false,gym:false,repair:true},
      4:{work:true,gym:true,repair:true},
      5:{work:false,gym:false,repair:true},
      6:{work:false,gym:true,repair:true}
    },
    skipped: storage.get('skipped') || {},
    supplements: storage.get('supplements') || {},
    showStats:true
  };

  this.colors={
    work:{bg:'#FF9500',text:'–†–∞–±–æ—Ç–∞',icon:'üíº'},
    gym:{bg:'#FF3B30',text:'–ó–∞–ª',icon:'üèãÔ∏è'},
    repair:{bg:'#FFCC00',text:'–†–µ–º–æ–Ω—Ç',icon:'üî®'}
  };
  this.slotsElements={};
  this.swipeInit=false;
  this.touchStartX=0;
  this.touchStartY=0;

  this.render();
  this.scrollToCurrent();
  
  setInterval(()=>this.render(), 60000);
}

save(){
  storage.set('schedule',this.state.schedule);
  storage.set('skipped',this.state.skipped);
  storage.set('supplements',this.state.supplements);
}

getDateForDay(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  const months=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞—è','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return `${m.getDate()} ${months[m.getMonth()]}`;
}

getDateKey(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  return m.toISOString().split('T')[0];
}

toMin(t){
  const[h,m]=t.split(':').map(Number);
  return h*60+m;
}

isPast(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex < currentDayIndex) return true;
  if(dayIndex > currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH, endM] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  let endMinutes = endH * 60 + endM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return false;
    }
    return currentMinutes >= endMinutes;
  }
  
  if(endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }
  
  return currentMinutes >= endMinutes;
}

isFuture(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex > currentDayIndex) return true;
  if(dayIndex < currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return true;
    }
    return currentMinutes < startMinutes;
  }
  
  return currentMinutes < startMinutes;
}

isCurrent(slot, dayIndex){
  if(!slot.t.includes('-')) return false;
  
  const now = new Date();
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(dayIndex !== currentDayIndex) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const [startTime, endTime] = slot.t.split('-');
  const [startH, startM] = startTime.split(':').map(Number);
  const [endH, endM] = endTime.split(':').map(Number);
  
  let startMinutes = startH * 60 + startM;
  let endMinutes = endH * 60 + endM;
  
  if(startH === 0 && endH < 12 && endH > 0) {
    if(currentMinutes >= 12 * 60) {
      return false;
    }
    return currentMinutes >= startMinutes && currentMinutes < endMinutes;
  }
  
  if(endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }
  
  return currentMinutes >= startMinutes && currentMinutes < endMinutes;
}

getSlots(dayIndex){
  const {work,gym,repair}=this.state.schedule[dayIndex];
  const s=[];
  if(work){
    s.push(
      {t:'06:00-06:20',a:'–ü–æ–¥—ä–µ–º',c:'bg-orange-50',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'06:20-06:30',a:'–°–±–æ—Ä—ã',c:'bg-orange-100',id:'prep'},
      {t:'06:30-07:00',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-50',id:'commute1'},
      {t:'07:00-15:00',a:'–†–∞–±–æ—Ç–∞',c:'bg-orange-100',id:'work',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']},
      {t:'15:00-15:30',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-50',id:'commute2'},
      {t:'15:30-16:00',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'}
    );
    s.push(repair
      ?{t:'16:00-19:00',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-50',id:'repair'}
      :{t:'16:00-19:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free1'}
    );
  } else {
    s.push(
      {t:'06:00-09:00',a:'–°–æ–Ω +3—á',c:'bg-indigo-50',id:'sleep2'},
      {t:'09:00-09:30',a:'–ü–æ–¥—ä–µ–º',c:'bg-indigo-100',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'09:30-10:30',a:'–ó–∞–≤—Ç—Ä–∞–∫',c:'bg-green-50',id:'breakfast',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']}
    );
    if(repair){
      s.push(
        {t:'10:30-13:30',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-50',id:'repair1'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'},
        {t:'14:30-18:30',a:'–†–µ–º–æ–Ω—Ç 4—á',c:'bg-yellow-100',id:'repair2'}
      );
    } else {
      s.push(
        {t:'10:30-13:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free2'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-50',id:'lunch'},
        {t:'14:30-18:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free3'}
      );
    }
  }
  if(gym){
    s.push(
      {t:'19:00-19:30',a:'–ö –∑–∞–ª—É',c:'bg-red-50',id:'gym1',supps:['–ë–µ—Ç–∞-–∞–ª–∞–Ω–∏–Ω','–¶–∏—Ç—Ä—É–ª–∏–Ω']},
      {t:'19:30-21:00',a:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',c:'bg-red-100',id:'gym'},
      {t:'21:00-21:30',a:'–û—Ç –∑–∞–ª–∞',c:'bg-red-50',id:'gym2',supps:['–ö—Ä–µ–∞—Ç–∏–Ω','–ì–µ–π–Ω–µ—Ä']},
      {t:'21:30-22:30',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
      {t:'22:30-23:30',a:'–ö—É—Ä—Å',c:'bg-purple-50',id:'course'},
      {t:'23:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
    );
  } else {
    if(work){
      s.push(
        {t:'19:00-20:00',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
        {t:'20:00-22:00',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-100',id:'course'},
        {t:'22:00-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    } else {
      s.push(
        {t:'18:30-19:30',a:'–£–∂–∏–Ω',c:'bg-green-50',id:'dinner'},
        {t:'19:30-21:30',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-100',id:'course'},
        {t:'21:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-50',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    }
  }
  s.push({t:'00:00-06:00',a:'–°–æ–Ω',c:'bg-indigo-100',id:'sleep'});
  return s;
}

renderDailySuppStats(dayIndex){
  const dayDate=this.getDateKey(dayIndex);
  const slots=this.getSlots(dayIndex);

  let total=0, taken=0;
  slots.forEach((slot,i)=>{
    if(slot.supps){
      slot.supps.forEach((s,si)=>{
        total++;
        const sk=`${dayDate}-${slot.id}-${i}-s${si}`;
        if(this.state.supplements[sk]) taken++;
      });
    }
  });

  if(total===0) return '';

  const percent=Math.round((taken/total)*100);

  return `
    <div class="card p-4 mb-4">
      <div class="flex justify-between items-center mb-2">
        <span class="text-base font-semibold" style="color:#1C1C1E;">üíä –°–ø–æ—Ä—Ç–ø–∏—Ç</span>
        <span class="progress-percent text-2xl font-bold" style="color:#34C759;">${percent}%</span>
      </div>
      <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden">
        <div class="progress-bar-inner h-full rounded-full" style="width:${percent}%"></div>
      </div>
      <div class="mt-2 text-xs text-gray-500">${taken} –∏–∑ ${total} –ø—Ä–∏–Ω—è—Ç—ã</div>
    </div>
  `;
}

render(){
  this.slotsElements={};
  const dayIndex=this.state.selectedDay;
  const dayDate=this.getDateKey(dayIndex);
  const slots=this.getSlots(dayIndex);
  const container=document.getElementById('app');
  container.innerHTML='';

  // Header
  const header=document.createElement('div');
  header.className='p-4 pb-0';
  header.innerHTML=`
    <h1 class="header-title mb-1">${this.days[dayIndex]}</h1>
    <p class="text-base text-gray-500 mb-4">${this.getDateForDay(dayIndex)}</p>
    ${this.renderDailySuppStats(dayIndex)}
  `;
  container.appendChild(header);

  // Category buttons
  const opts=document.createElement('div');
  opts.className='flex gap-2 px-4 mb-4';
  ['work','gym','repair'].forEach(type=>{
    const btn=document.createElement('button');
    const cfg=this.colors[type];
    const isActive=this.state.schedule[dayIndex][type];
    btn.className=`category-btn flex-1 py-3 text-white font-semibold ${isActive?'':'opacity-50'}`;
    btn.style.background=isActive?cfg.bg:'#E5E5EA';
    btn.style.color=isActive?'white':'#8E8E93';
    btn.innerHTML=`${cfg.icon} ${cfg.text}`;
    btn.addEventListener('click',()=>{
      this.state.schedule[dayIndex][type]=!this.state.schedule[dayIndex][type];
      this.save();
      this.render();
    });
    opts.appendChild(btn);
  });
  container.appendChild(opts);

  // Slots
  const slotsContainer=document.createElement('div');
  slotsContainer.className='flex-1 overflow-y-auto px-4';

  slots.forEach((slot,i)=>{
    const key=`${dayDate}-${slot.id}-${i}`;
    const slotDiv=document.createElement('div');
    
    const isSkipped=this.state.skipped[key];
    const isPast = this.isPast(slot, dayIndex);
    const isCurrent = this.isCurrent(slot, dayIndex);
    
    let slotClass = `slot p-4 mb-3 ${slot.c}`;
    if(isCurrent) slotClass += ' current-time';
    if(isPast) slotClass += ' past-slot';
    if(isSkipped) slotClass += ' skipped-slot';
    
    slotDiv.className = slotClass;

    let suppHtml='';
    if(slot.supps){
      suppHtml='<div class="mt-3 pt-3 border-t border-gray-100">';
      slot.supps.forEach((s,si)=>{
        const sk=`${key}-s${si}`;
        const taken=this.state.supplements[sk];
        suppHtml+=`
          <div class="flex items-center gap-2 mb-2">
            <button class="supp-btn supp-checkbox ${taken?'checked':''}" data-key="${sk}">
              ${taken?'‚úì':''}
            </button>
            <span class="text-sm ${taken?'line-through text-gray-400':'text-gray-700'}">üíä ${s}</span>
          </div>`;
      });
      suppHtml+='</div>';
    }

    const showSkipBtn = isPast;

    slotDiv.innerHTML=`
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="text-sm font-semibold text-gray-500 mb-0.5">${slot.t}</div>
          <div class="text-base font-semibold" style="color:#1C1C1E;">${slot.a}</div>
          ${suppHtml}
        </div>
        ${showSkipBtn ? `<button class="skip-btn ${isSkipped?'skipped':''}">
          ${isSkipped?'–ü—Ä–æ–ø—É—â–µ–Ω–æ':'–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'}
        </button>` : ''}
      </div>`;

    const skipBtn = slotDiv.querySelector('.skip-btn');
    if(skipBtn){
      skipBtn.onclick = ()=>{
        this.state.skipped[key]=!this.state.skipped[key];
        this.save();
        skipBtn.textContent = this.state.skipped[key] ? '–ü—Ä–æ–ø—É—â–µ–Ω–æ' : '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å';
        skipBtn.classList.toggle('skipped',this.state.skipped[key]);
        slotDiv.classList.toggle('skipped-slot',this.state.skipped[key]);
      };
    }

    slotDiv.querySelectorAll('.supp-btn').forEach(b=>{
      b.onclick=()=>{
        const k=b.dataset.key;
        this.state.supplements[k]=!this.state.supplements[k];
        this.save();
        b.textContent=this.state.supplements[k]?'‚úì':'';
        b.classList.toggle('checked',this.state.supplements[k]);

        const progressBar = document.querySelector('.progress-bar-inner');
        const percentLabel = document.querySelector('.progress-percent');
        let total=0,taken=0;
        slots.forEach((slot2,ii)=>{
          if(slot2.supps){
            slot2.supps.forEach((s2,si2)=>{
              total++;
              const sk2=`${dayDate}-${slot2.id}-${ii}-s${si2}`;
              if(this.state.supplements[sk2]) taken++;
            });
          }
        });
        const targetPercent=Math.round((taken/total)*100);

        let current=parseInt(percentLabel.textContent)||0;
        const step = targetPercent > current ? 1 : -1;
        const interval = setInterval(()=>{
          current+=step;
          percentLabel.textContent = current+'%';
          progressBar.style.width = current+'%';
          if(current===targetPercent) clearInterval(interval);
        },10);
      };
    });

    slotsContainer.appendChild(slotDiv);
    this.slotsElements[key]=slotDiv;
  });

  container.appendChild(slotsContainer);

  // Footer
  const footer=document.createElement('div');
  footer.className='card fixed bottom-4 left-4 right-4 p-2 flex justify-between gap-1';
  this.days.forEach((d,i)=>{
    const btn=document.createElement('button');
    btn.className=`day-btn flex-1 py-2.5 ${i===dayIndex?'active':''}`;
    btn.innerText=d;
    btn.addEventListener('click',()=>{
      this.state.selectedDay=i;
      this.render();
      this.scrollToCurrent();
    });
    footer.appendChild(btn);
  });
  container.appendChild(footer);

  this.setupSwipe();
}

setupSwipe(){
  if(this.swipeInit) return;
  this.swipeInit=true;
  const container=document.getElementById('app');
  container.addEventListener('touchstart',e=>{
    this.touchStartX=e.touches[0].clientX;
    this.touchStartY=e.touches[0].clientY;
  });
  container.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-this.touchStartX;
    const dy=e.changedTouches[0].clientY-this.touchStartY;
    if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)){
      this.state.selectedDay=Math.min(6,Math.max(0,this.state.selectedDay+(dx<0?1:-1)));
      this.render();
      this.scrollToCurrent();
    }
  });
}

scrollToCurrent(){
  const today = new Date();
  const currentDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
  
  if(this.state.selectedDay === currentDayIndex){
    Object.values(this.slotsElements).find(e=>{
      if(e.classList.contains('current-time')){
        e.scrollIntoView({behavior:'smooth',block:'center'});
        return true;
      }
    });
  } else {
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
}

}

new Planner();
</script>
</body>
</html>
