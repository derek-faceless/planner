<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
<script src="https://cdn.tailwindcss.com"></script>

<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
  .current-time {
    border-left-width: 4px;
    border-left-color: #3b82f6;
    animation: pulse 2s ease-in-out infinite;
    box-shadow: 0 0 0 4px rgba(59,130,246,.1);
  }
  @keyframes pulse {
    50% {
      border-left-color: #2563eb;
      box-shadow: 0 0 0 8px rgba(59,130,246,.2);
    }
  }
  .slot { transition: background .3s, border-left .3s; }
  .progress-bar-inner { transition: width 0.3s ease; }
</style>
</head>

<body class="bg-gray-50 flex flex-col min-h-screen">
<div id="app" class="flex-1 flex flex-col overflow-hidden pb-16"></div>

<script>
const storage = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
};

class Planner {
constructor(){
  const today=new Date();
  this.days=['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
  this.state={
    selectedDay: today.getDay()===0?6:today.getDay()-1,
    schedule: storage.get('schedule') || {
      0:{work:true,gym:true,repair:true},
      1:{work:false,gym:false,repair:true},
      2:{work:true,gym:true,repair:true},
      3:{work:false,gym:false,repair:true},
      4:{work:true,gym:true,repair:true},
      5:{work:false,gym:false,repair:true},
      6:{work:false,gym:true,repair:true}
    },
    completed: storage.get('completed') || {},
    supplements: storage.get('supplements') || {},
    showStats:true
  };

  this.colors={work:'orange',gym:'red',repair:'yellow'};
  this.slotsElements={};
  this.swipeInit=false;
  this.touchStartX=0;
  this.touchStartY=0;

  this.render();
  this.scrollToCurrent();
}

save(){
  storage.set('schedule',this.state.schedule);
  storage.set('completed',this.state.completed);
  storage.set('supplements',this.state.supplements);
}

getDateForDay(i){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-t.getDay()+1+i);
  return m.toISOString().split('T')[0];
}

toMin(t){
  const[h,m]=t.split(':').map(Number);
  return h*60+m;
}

isCurrent(slot){
  if(!slot.t.includes('-')) return false;
  const now=new Date();
  let cur=this.toMin(`${now.getHours()}:${now.getMinutes()}`);
  let [s,e]=slot.t.split('-').map(this.toMin);
  if(e<=s) e+=1440;
  if(cur<s) cur+=1440;
  return cur>=s && cur<e;
}

/* ===== getSlots ===== */
getSlots(dayIndex){
  const {work,gym,repair}=this.state.schedule[dayIndex];
  const s=[];
  if(work){
    s.push(
      {t:'06:00-06:20',a:'–ü–æ–¥—ä–µ–º',c:'bg-orange-100',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'06:20-06:30',a:'–°–±–æ—Ä—ã',c:'bg-orange-200',id:'prep'},
      {t:'06:30-07:00',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-100',id:'commute1'},
      {t:'07:00-15:00',a:'–†–∞–±–æ—Ç–∞',c:'bg-orange-300',id:'work',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']},
      {t:'15:00-15:30',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-100',id:'commute2'},
      {t:'15:30-16:00',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'}
    );
    s.push(repair
      ?{t:'16:00-19:00',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-200',id:'repair'}
      :{t:'16:00-19:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-100',id:'free1'}
    );
  } else {
    s.push(
      {t:'06:00-09:00',a:'–°–æ–Ω +3—á',c:'bg-indigo-100',id:'sleep2'},
      {t:'09:00-09:30',a:'–ü–æ–¥—ä–µ–º',c:'bg-indigo-200',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
      {t:'09:30-10:30',a:'–ó–∞–≤—Ç—Ä–∞–∫',c:'bg-green-200',id:'breakfast',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']}
    );
    if(repair){
      s.push(
        {t:'10:30-13:30',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-200',id:'repair1'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'},
        {t:'14:30-18:30',a:'–†–µ–º–æ–Ω—Ç 4—á',c:'bg-yellow-300',id:'repair2'}
      );
    } else {
      s.push(
        {t:'10:30-13:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-100',id:'free2'},
        {t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'},
        {t:'14:30-18:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free3'}
      );
    }
  }
  if(gym){
    s.push(
      {t:'19:00-19:30',a:'–ö –∑–∞–ª—É',c:'bg-red-100',id:'gym1',supps:['–ë–µ—Ç–∞-–∞–ª–∞–Ω–∏–Ω','–¶–∏—Ç—Ä—É–ª–∏–Ω']},
      {t:'19:30-21:00',a:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',c:'bg-red-300',id:'gym'},
      {t:'21:00-21:30',a:'–û—Ç –∑–∞–ª–∞',c:'bg-red-100',id:'gym2',supps:['–ö—Ä–µ–∞—Ç–∏–Ω','–ì–µ–π–Ω–µ—Ä']},
      {t:'21:30-22:30',a:'–£–∂–∏–Ω',c:'bg-green-200',id:'dinner'},
      {t:'22:30-23:30',a:'–ö—É—Ä—Å',c:'bg-purple-200',id:'course'},
      {t:'23:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
    );
  } else {
    if(work){
      s.push(
        {t:'19:00-20:00',a:'–£–∂–∏–Ω',c:'bg-green-200',id:'dinner'},
        {t:'20:00-22:00',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-300',id:'course'},
        {t:'22:00-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    } else {
      s.push(
        {t:'18:30-19:30',a:'–£–∂–∏–Ω',c:'bg-green-200',id:'dinner'},
        {t:'19:30-21:30',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-300',id:'course'},
        {t:'21:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    }
  }
  s.push({t:'00:00-06:00',a:'–°–æ–Ω',c:'bg-indigo-300',id:'sleep'});
  return s;
}

/* ===== –î–ù–ï–í–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ü–û–†–¢–ü–ò–¢–ê –° –ê–ù–ò–ú–ê–¶–ò–ï–ô ===== */
renderDailySuppStats(dayIndex){
  const dayDate=this.getDateForDay(dayIndex);
  const slots=this.getSlots(dayIndex);

  let total=0, taken=0;
  slots.forEach((slot,i)=>{
    if(slot.supps){
      slot.supps.forEach((s,si)=>{
        total++;
        const sk=`${dayDate}-${slot.id}-${i}-s${si}`;
        if(this.state.supplements[sk]) taken++;
      });
    }
  });

  if(total===0) return '';

  const percent=Math.round((taken/total)*100);

  return `
    <div class="mt-3 p-3 rounded bg-teal-50 border border-teal-200">
      <div class="flex justify-between text-sm font-semibold text-teal-800 mb-1">
        <span>üíä –°–ø–æ—Ä—Ç–ø–∏—Ç —Å–µ–≥–æ–¥–Ω—è</span>
        <span class="progress-percent">${percent}%</span>
      </div>
      <div class="w-full h-2 bg-teal-100 rounded overflow-hidden">
        <div class="progress-bar-inner h-full bg-teal-500" style="width:${percent}%"></div>
      </div>
    </div>
  `;
}

/* ===== RENDER ===== */
render(){
  this.slotsElements={};
  const dayIndex=this.state.selectedDay;
  const dayDate=this.getDateForDay(dayIndex);
  const slots=this.getSlots(dayIndex);
  const container=document.getElementById('app');
  container.innerHTML='';

  // ===== Header + –ø—Ä–æ–≥—Ä–µ—Å—Å =====
  const header=document.createElement('div');
  header.className='p-4';
  header.innerHTML=`
    <h1 class="text-xl font-bold mb-2">üìÖ ${this.days[dayIndex]} ${dayDate}</h1>
    ${this.renderDailySuppStats(dayIndex)}
  `;
  container.appendChild(header);

  // ===== –†–∞–±–æ—Ç–∞ / –ó–∞–ª / –†–µ–º–æ–Ω—Ç =====
  const opts=document.createElement('div');
  opts.className='flex gap-2 mb-4 px-4';
  ['work','gym','repair'].forEach(type=>{
    const btn=document.createElement('button');
    const color=this.colors[type];
    btn.className=`flex-1 py-2 rounded text-white ${this.state.schedule[dayIndex][type]?`bg-${color}-500`:'bg-gray-400'}`;
    btn.innerText=type==='work'?'–†–∞–±–æ—Ç–∞':type==='gym'?'–ó–∞–ª':'–†–µ–º–æ–Ω—Ç';
    btn.addEventListener('click',()=>{
      this.state.schedule[dayIndex][type]=!this.state.schedule[dayIndex][type];
      this.save();
      this.render();
    });
    opts.appendChild(btn);
  });
  container.appendChild(opts);

  // ===== –°–ª–æ—Ç—ã =====
  const slotsContainer=document.createElement('div');
  slotsContainer.className='flex-1 overflow-y-auto px-4';

  slots.forEach((slot,i)=>{
    const key=`${dayDate}-${slot.id}-${i}`;
    const slotDiv=document.createElement('div');
    slotDiv.className=`slot p-3 mb-2 rounded ${slot.c} ${this.isCurrent(slot)?'current-time':''}`;

    const done=this.state.completed[key];

    let suppHtml='';
    if(slot.supps){
      suppHtml='<div class="mt-1 pt-1 border-t border-teal-300 bg-teal-50 px-2 py-1 rounded">';
      slot.supps.forEach((s,si)=>{
        const sk=`${key}-s${si}`;
        const taken=this.state.supplements[sk];
        suppHtml+=`
          <div class="flex items-center gap-2 mb-0.5">
            <button class="supp-btn w-4 h-4 border rounded ${taken?'bg-green-500':'border-gray-400'}" data-key="${sk}">${taken?'‚úì':''}</button>
            <span class="text-xs ${taken?'line-through text-gray-500':'text-teal-700'}">üíä ${s}</span>
          </div>`;
      });
      suppHtml+='</div>';
    }

    slotDiv.innerHTML=`
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold">${slot.t}</div>
          <div>${slot.a}</div>
          ${suppHtml}
        </div>
        <button class="task-btn w-6 h-6 border-2 rounded ${done?'bg-green-500':'border-gray-400'}">${done?'‚úì':''}</button>
      </div>`;

    const taskBtn = slotDiv.querySelector('.task-btn');
    taskBtn.onclick = ()=>{
      this.state.completed[key]=!this.state.completed[key];
      this.save();
      taskBtn.textContent = this.state.completed[key] ? '‚úì' : '';
      taskBtn.classList.toggle('bg-green-500',this.state.completed[key]);
      taskBtn.classList.toggle('border-gray-400',!this.state.completed[key]);
      slotDiv.classList.toggle('opacity-80',this.state.completed[key]);
    };

    slotDiv.querySelectorAll('.supp-btn').forEach(b=>{
      b.onclick=()=>{
        const k=b.dataset.key;
        this.state.supplements[k]=!this.state.supplements[k];
        this.save();
        b.textContent=this.state.supplements[k]?'‚úì':'';
        b.classList.toggle('bg-green-500',this.state.supplements[k]);

        // ===== –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ =====
        const progressBar = document.querySelector('.progress-bar-inner');
        const percentLabel = document.querySelector('.progress-percent');
        let total=0,taken=0;
        slots.forEach((slot2,ii)=>{
          if(slot2.supps){
            slot2.supps.forEach((s2,si2)=>{
              total++;
              const sk2=`${dayDate}-${slot2.id}-${ii}-s${si2}`;
              if(this.state.supplements[sk2]) taken++;
            });
          }
        });
        const targetPercent=Math.round((taken/total)*100);

        // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–ª–∞
        let current=parseInt(percentLabel.textContent)||0;
        const step = targetPercent > current ? 1 : -1;
        const interval = setInterval(()=>{
          current+=step;
          percentLabel.textContent = current+'%';
          progressBar.style.width = current+'%';
          if(current===targetPercent) clearInterval(interval);
        },10);
      };
    });

    slotsContainer.appendChild(slotDiv);
    this.slotsElements[key]=slotDiv;
  });

  container.appendChild(slotsContainer);

  // ===== –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –¥–Ω–µ–π =====
  const footer=document.createElement('div');
  footer.className='bg-white border-t flex justify-between p-2 fixed bottom-0 w-full';
  this.days.forEach((d,i)=>{
    const btn=document.createElement('button');
    btn.className=`flex-1 py-2 mx-1 rounded ${i===dayIndex?'bg-blue-500 text-white':'bg-gray-200'}`;
    btn.innerText=d;
    btn.addEventListener('click',()=>{
      this.state.selectedDay=i;
      this.render();
      this.scrollToCurrent();
    });
    footer.appendChild(btn);
  });
  container.appendChild(footer);

  this.setupSwipe();
}

setupSwipe(){
  if(this.swipeInit) return;
  this.swipeInit=true;
  const container=document.getElementById('app');
  container.addEventListener('touchstart',e=>{
    this.touchStartX=e.touches[0].clientX;
    this.touchStartY=e.touches[0].clientY;
  });
  container.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-this.touchStartX;
    const dy=e.changedTouches[0].clientY-this.touchStartY;
    if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)){
      this.state.selectedDay=Math.min(6,Math.max(0,this.state.selectedDay+(dx<0?1:-1)));
      this.render();
      this.scrollToCurrent();
    }
  });
}

scrollToCurrent(){
  Object.values(this.slotsElements).find(e=>{
    if(e.classList.contains('current-time')){
      e.scrollIntoView({behavior:'smooth',block:'center'});
      return true;
    }
  });
}

}

new Planner();
</script>
</body>
</html>
