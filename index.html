<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÐœÐ¾Ð¹ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
  .current-time { border-left-width: 4px; border-left-color: #3b82f6; }
  .slot { transition: background 0.3s, border-left 0.3s; }
</style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
<div id="app" class="flex-1 flex flex-col overflow-hidden"></div>

<script>
// ===== Service Worker registration =====
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js')
  .then(()=>console.log('Service Worker Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½'))
  .catch(e=>console.error('ÐžÑˆÐ¸Ð±ÐºÐ° SW:', e));
}
</script>

<script>
// ===== ÐŸÐ»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº (Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÐºÐ¾Ð´, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ð»Ð¸) =====
const storage = {
  get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
};

class Planner {
  constructor() {
    const today = new Date();
    this.days = ['ÐŸÐ','Ð’Ð¢','Ð¡Ð ','Ð§Ð¢','ÐŸÐ¢','Ð¡Ð‘','Ð’Ð¡'];
    this.state = {
      weekOffset: 0,
      selectedDay: today.getDay()===0?6:today.getDay()-1,
      schedule: storage.get('schedule') || {
        0:{work:true,gym:true,repair:true},1:{work:false,gym:false,repair:true},
        2:{work:true,gym:true,repair:true},3:{work:false,gym:false,repair:true},
        4:{work:true,gym:true,repair:true},5:{work:false,gym:false,repair:true},
        6:{work:false,gym:true,repair:true}
      },
      completed: storage.get('completed')||{},
      supplements: storage.get('supplements')||{}
    };

    this.colors = { work:'orange', gym:'red', repair:'yellow' };

    this.suppConfig = [
      {id:1,name:'ÐÐ¼Ð¸Ð½Ð¾ÐºÐ¸ÑÐ»Ð¾Ñ‚Ñ‹',icon:'ðŸ’Š',timing:'wake'},
      {id:2,name:'ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð½ (ÑƒÑ‚Ñ€Ð¾)',icon:'ðŸ’Š',timing:'wake'},
      {id:3,name:'ÐœÑƒÐ»ÑŒÑ‚Ð¸-Ð’Ð¸Ñ‚Ð°Ð¼Ð¸Ð½Ñ‹',icon:'ðŸŒŸ',timing:'breakfast'},
      {id:4,name:'ÐžÐ¼ÐµÐ³Ð° 3',icon:'ðŸŸ',timing:'breakfast'},
      {id:5,name:'Ð‘ÐµÑ‚Ð°-Ð°Ð»Ð°Ð½Ð¸Ð½',icon:'âš¡',timing:'pre-gym',gymOnly:true},
      {id:6,name:'Ð¦Ð¸Ñ‚Ñ€ÑƒÐ»Ð¸Ð½',icon:'âš¡',timing:'pre-gym',gymOnly:true},
      {id:7,name:'ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð½ (Ð¿Ð¾ÑÐ»Ðµ)',icon:'ðŸ’Š',timing:'post-gym',gymOnly:true},
      {id:8,name:'Ð“ÐµÐ¹Ð½ÐµÑ€',icon:'ðŸ¥¤',timing:'post-gym',gymOnly:true,opt:true},
      {id:9,name:'GABA',icon:'ðŸ˜´',timing:'sleep'},
      {id:10,name:'B-ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ',icon:'ðŸ’Š',timing:'sleep'}
    ];

    this.slotsElements = {};
    this.render();
    this.scrollToCurrent();
  }

  save(){storage.set('schedule', this.state.schedule); storage.set('completed', this.state.completed); storage.set('supplements', this.state.supplements);}
  getDateForDay(i){ const today = new Date(); const mon = new Date(today); mon.setDate(today.getDate()-today.getDay()+1+this.state.weekOffset*7+i); return mon.toISOString().split('T')[0]; }

  getSlots(dayIndex){
    const {work,gym,repair}=this.state.schedule[dayIndex];
    const s=[];
    if(work){
      s.push(
        {t:'06:00-06:20',a:'ÐŸÐ¾Ð´ÑŠÐµÐ¼',c:'bg-orange-100',id:'wake',supps:['ÐÐ¼Ð¸Ð½Ð¾ÐºÐ¸ÑÐ»Ð¾Ñ‚Ñ‹','ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð½']},
        {t:'06:20-06:30',a:'Ð¡Ð±Ð¾Ñ€Ñ‹',c:'bg-orange-200',id:'prep'},
        {t:'06:30-07:00',a:'Ð”Ð¾Ñ€Ð¾Ð³Ð°',c:'bg-orange-100',id:'commute1'},
        {t:'07:00-15:00',a:'Ð Ð°Ð±Ð¾Ñ‚Ð°',c:'bg-orange-300',id:'work',supps:['ÐœÑƒÐ»ÑŒÑ‚Ð¸-Ð’Ð¸Ñ‚Ð°Ð¼Ð¸Ð½Ñ‹','ÐžÐ¼ÐµÐ³Ð° 3']},
        {t:'15:00-15:30',a:'Ð”Ð¾Ñ€Ð¾Ð³Ð°',c:'bg-orange-100',id:'commute2'},
        {t:'15:30-16:00',a:'ÐžÐ±ÐµÐ´',c:'bg-green-100',id:'lunch'}
      );
      s.push(repair?{t:'16:00-19:00',a:'Ð ÐµÐ¼Ð¾Ð½Ñ‚ 3Ñ‡',c:'bg-yellow-200',id:'repair'}:{t:'16:00-19:00',a:'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾',c:'bg-gray-100',id:'free1'});
    } else {
      s.push({t:'06:00-09:00',a:'Ð¡Ð¾Ð½ +3Ñ‡',c:'bg-indigo-100',id:'sleep2'});
      s.push({t:'09:00-09:30',a:'ÐŸÐ¾Ð´ÑŠÐµÐ¼',c:'bg-indigo-200',id:'wake',supps:['ÐÐ¼Ð¸Ð½Ð¾ÐºÐ¸ÑÐ»Ð¾Ñ‚Ñ‹','ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð½']});
      s.push({t:'09:30-10:30',a:'Ð—Ð°Ð²Ñ‚Ñ€Ð°Ðº',c:'bg-green-200',id:'breakfast',supps:['ÐœÑƒÐ»ÑŒÑ‚Ð¸-Ð’Ð¸Ñ‚Ð°Ð¼Ð¸Ð½Ñ‹','ÐžÐ¼ÐµÐ³Ð° 3']});
      if(repair){s.push({t:'10:30-13:30',a:'Ð ÐµÐ¼Ð¾Ð½Ñ‚ 3Ñ‡',c:'bg-yellow-200',id:'repair1'}); s.push({t:'13:30-14:30',a:'ÐžÐ±ÐµÐ´',c:'bg-green-100',id:'lunch'}); s.push({t:'14:30-18:30',a:'Ð ÐµÐ¼Ð¾Ð½Ñ‚ 4Ñ‡',c:'bg-yellow-300',id:'repair2'});}
      else{s.push({t:'10:30-13:30',a:'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾',c:'bg-gray-100',id:'free2'}); s.push({t:'13:30-14:30',a:'ÐžÐ±ÐµÐ´',c:'bg-green-100',id:'lunch'}); s.push({t:'14:30-18:30',a:'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾',c:'bg-gray-200',id:'free3'});}
    }
    if(gym){ s.push({t:'19:00-19:30',a:'Ðš Ð·Ð°Ð»Ñƒ',c:'bg-red-100',id:'gym1',supps:['Ð‘ÐµÑ‚Ð°-Ð°Ð»Ð°Ð½Ð¸Ð½','Ð¦Ð¸Ñ‚Ñ€ÑƒÐ»Ð¸Ð½']},{t:'19:30-21:00',a:'Ð¢Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°',c:'bg-red-300',id:'gym'},{t:'21:00-21:30',a:'ÐžÑ‚ Ð·Ð°Ð»Ð°',c:'bg-red-100',id:'gym2',supps:['ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð½','Ð“ÐµÐ¹Ð½ÐµÑ€']},{t:'21:30-22:30',a:'Ð£Ð¶Ð¸Ð½',c:'bg-green-200',id:'dinner'},{t:'22:30-23:30',a:'ÐšÑƒÑ€Ñ',c:'bg-purple-200',id:'course'},{t:'23:30-00:00',a:'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾',c:'bg-gray-200',id:'free',supps:['GABA','B-ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ']}); }
    else{ if(work){s.push({t:'19:00-20:00',a:'Ð£Ð¶Ð¸Ð½',c:'bg-green-200',id:'dinner'});s.push({t:'20:00-22:00',a:'ÐšÑƒÑ€Ñ 2Ñ‡',c:'bg-purple-300',id:'course'});s.push({t:'22:00-00:00',a:'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾',c:'bg-gray-200',id:'free',supps:['GABA','B-ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ']});}
    else{s.push({t:'18:30-19:30',a:'Ð£Ð¶Ð¸Ð½',c:'bg-green-200',id:'dinner'});s.push({t:'19:30-21:30',a:'ÐšÑƒÑ€Ñ 2Ñ‡',c:'bg-purple-300',id:'course'});s.push({t:'21:30-00:00',a:'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾',c:'bg-gray-200',id:'free',supps:['GABA','B-ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ']});}}
    s.push({t:'00:00',a:'Ð¡Ð¾Ð½',c:'bg-indigo-300',id:'sleep'}); return s;
  }

  isCurrent(slot){ const now=new Date(); const [start,end]=slot.t.split('-').map(t=>{const [h,m]=t.split(':').map(Number);return h*60+m;}); const curMins=now.getHours()*60+now.getMinutes(); return curMins>=start && curMins<=(end||start+30); }

  toggleOption(dayIndex,type){ this.state.schedule[dayIndex][type]=!this.state.schedule[dayIndex][type]; this.save(); this.render(); this.scrollToCurrent(); }

  render(){
    const dayIndex=this.state.selectedDay;
    const dayDate=this.getDateForDay(dayIndex);
    const slots=this.getSlots(dayIndex);
    const container=document.getElementById('app');
    container.innerHTML='';

    // Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº
    const header=document.createElement('div');
    header.className='p-4';
    header.innerHTML=`<h1 class="text-xl font-bold mb-2">ðŸ“… ${this.days[dayIndex]} ${dayDate}</h1>`;
    container.appendChild(header);

    // Ð’ÐµÑ€Ñ…Ð½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸
    const opts=document.createElement('div');
    opts.className='flex gap-2 mb-4 px-4';
    ['work','gym','repair'].forEach(type=>{
      const btn=document.createElement('button');
      const color=this.colors[type];
      btn.className=`flex-1 py-2 rounded text-white ${this.state.schedule[dayIndex][type]?`bg-${color}-500`:'bg-gray-400'}`;
      btn.innerText=type==='work'?'Ð Ð°Ð±Ð¾Ñ‚Ð°':type==='gym'?'Ð—Ð°Ð»':'Ð ÐµÐ¼Ð¾Ð½Ñ‚';
      btn.addEventListener('click',()=>this.toggleOption(dayIndex,type));
      opts.appendChild(btn);
    });
    container.appendChild(opts);

    // Ð¡Ð»Ð¾Ñ‚Ñ‹
    const slotsContainer=document.createElement('div');
    slotsContainer.className='flex-1 overflow-y-auto px-4';
    slots.forEach(slot=>{
      const key=`${dayDate}-${slot.id}`;
      const slotDiv=document.createElement('div');
      slotDiv.className=`slot p-3 mb-2 rounded ${slot.c} ${this.isCurrent(slot)?'current-time':''}`;
      // task btn
      const taskBtn=`<button class="task-btn w-6 h-6 border-2 rounded ${this.state.completed[key]?'bg-green-500':'border-gray-400'}">${this.state.completed[key]?'âœ“':''}</button>`;
      let suppHtml='';
      if(slot.supps){
        suppHtml='<div class="mt-1 pt-1 border-t border-teal-300 bg-teal-50 px-2 py-1 rounded">';
        slot.supps.forEach((s,i)=>{
          const skey=`${key}-${i}`;
          const taken=this.state.supplements[skey];
          suppHtml+=`<div class="flex items-center gap-2 mb-0.5">
            <button class="supp-btn w-4 h-4 border rounded ${taken?'bg-green-500':'border-gray-400'}" data-key="${skey}">${taken?'âœ“':''}</button>
            <span class="text-xs ${taken?'line-through text-gray-500':'text-teal-700'}">ðŸ’Š ${s}</span>
          </div>`;
        });
        suppHtml+='</div>';
      }
      slotDiv.innerHTML=`<div class="flex justify-between items-start">
        <div>
          <div class="font-semibold">${slot.t}</div>
          <div>${slot.a}</div>
          ${suppHtml}
        </div>
        ${taskBtn}
      </div>`;
      const tbtn=slotDiv.querySelector('.task-btn');
      tbtn.addEventListener('click',()=>{this.state.completed[key]=!this.state.completed[key]; this.save(); this.updateSlot(slotDiv,key);});
      slotDiv.querySelectorAll('.supp-btn').forEach(b=>{b.addEventListener('click',()=>{const skey=b.dataset.key; this.state.supplements[skey]=!this.state.supplements[skey]; this.save(); this.updateSupp(b,skey);});});
      slotsContainer.appendChild(slotDiv);
      this.slotsElements[key]=slotDiv;
    });
    container.appendChild(slotsContainer);

    // ÐÐ¸Ð¶Ð½ÑÑ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð´Ð½ÐµÐ¹
    const footer=document.createElement('div');
    footer.className='bg-white border-t flex justify-between p-2 sticky bottom-0';
    this.days.forEach((d,i)=>{
      const btn=document.createElement('button');
      btn.className=`flex-1 py-2 mx-1 rounded ${i===dayIndex?'bg-blue-500 text-white':'bg-gray-200'}`;
      btn.innerText=d;
      btn.addEventListener('click',()=>{this.state.selectedDay=i; this.render(); this.scrollToCurrent();});
      footer.appendChild(btn);
    });
    container.appendChild(footer);
  }

  updateSlot(slotDiv,key){
    const done=this.state.completed[key];
    const btn=slotDiv.querySelector('.task-btn');
    btn.className=`task-btn w-6 h-6 border-2 rounded ${done?'bg-green-500':'border-gray-400'}`;
    btn.innerText=done?'âœ“':'';
    if(done) slotDiv.classList.add('opacity-80'); else slotDiv.classList.remove('opacity-80');
  }
  updateSupp(btn,key){const taken=this.state.supplements[key]; btn.className=`supp-btn w-4 h-4 border rounded ${taken?'bg-green-500':'border-gray-400'}`; btn.innerText=taken?'âœ“':''; const label=btn.nextElementSibling; if(label) label.className=`text-xs ${taken?'line-through text-gray-500':'text-teal-700'}`;}
  scrollToCurrent(){const now=new Date(); const dayIndex=this.state.selectedDay; if(dayIndex!==(now.getDay()===0?6:now.getDay()-1)) return; const slots=Object.values(this.slotsElements); for(const s of slots){if(s.classList.contains('current-time')){s.scrollIntoView({behavior:'smooth',block:'center'}); break;}}}
}

const app=new Planner();
</script>
</body>
</html>
