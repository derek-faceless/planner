<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
  .current-time { border-left-width: 4px; border-left-color: #3b82f6; }
  .slot { transition: background 0.3s, border-left 0.3s; }
</style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
<div id="app" class="flex-1 flex flex-col overflow-hidden"></div>

<script>
const storage = {
  get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
};

class Planner {
  constructor() {
    const today = new Date();
    this.days = ['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
    this.state = {
      weekOffset: 0,
      selectedDay: today.getDay()===0?6:today.getDay()-1,
      schedule: storage.get('schedule') || {
        0:{work:true,gym:true,repair:true},1:{work:false,gym:false,repair:true},
        2:{work:true,gym:true,repair:true},3:{work:false,gym:false,repair:true},
        4:{work:true,gym:true,repair:true},5:{work:false,gym:false,repair:true},
        6:{work:false,gym:true,repair:true}
      },
      completed: storage.get('completed')||{},
      supplements: storage.get('supplements')||{}
    };

    this.colors = { work:'orange', gym:'red', repair:'yellow' };

    this.suppConfig = [
      {id:1,name:'–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã',icon:'üíä',timing:'wake'},
      {id:2,name:'–ö—Ä–µ–∞—Ç–∏–Ω (—É—Ç—Ä–æ)',icon:'üíä',timing:'wake'},
      {id:3,name:'–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã',icon:'üåü',timing:'breakfast'},
      {id:4,name:'–û–º–µ–≥–∞ 3',icon:'üêü',timing:'breakfast'},
      {id:5,name:'–ë–µ—Ç–∞-–∞–ª–∞–Ω–∏–Ω',icon:'‚ö°',timing:'pre-gym',gymOnly:true},
      {id:6,name:'–¶–∏—Ç—Ä—É–ª–∏–Ω',icon:'‚ö°',timing:'pre-gym',gymOnly:true},
      {id:7,name:'–ö—Ä–µ–∞—Ç–∏–Ω (–ø–æ—Å–ª–µ)',icon:'üíä',timing:'post-gym',gymOnly:true},
      {id:8,name:'–ì–µ–π–Ω–µ—Ä',icon:'ü•§',timing:'post-gym',gymOnly:true,opt:true},
      {id:9,name:'GABA',icon:'üò¥',timing:'sleep'},
      {id:10,name:'B-–∫–æ–º–ø–ª–µ–∫—Å',icon:'üíä',timing:'sleep'}
    ];

    this.slotsElements = {};
    this.render();
    this.scrollToCurrent();
  }

  save(){
    storage.set('schedule', this.state.schedule);
    storage.set('completed', this.state.completed);
    storage.set('supplements', this.state.supplements);
  }

  getDateForDay(i){
    const today = new Date();
    const mon = new Date(today);
    mon.setDate(today.getDate() - today.getDay() + 1 + this.state.weekOffset*7 + i);
    return mon.toISOString().split('T')[0];
  }

  getSlots(dayIndex){
    const {work,gym,repair}=this.state.schedule[dayIndex];
    const s=[];
    if(work){
      s.push(
        {t:'06:00-06:20',a:'–ü–æ–¥—ä–µ–º',c:'bg-orange-100',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']},
        {t:'06:20-06:30',a:'–°–±–æ—Ä—ã',c:'bg-orange-200',id:'prep'},
        {t:'06:30-07:00',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-100',id:'commute1'},
        {t:'07:00-15:00',a:'–†–∞–±–æ—Ç–∞',c:'bg-orange-300',id:'work',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']},
        {t:'15:00-15:30',a:'–î–æ—Ä–æ–≥–∞',c:'bg-orange-100',id:'commute2'},
        {t:'15:30-16:00',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'}
      );
      s.push(repair?{t:'16:00-19:00',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-200',id:'repair'}:{t:'16:00-19:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-100',id:'free1'});
    } else {
      s.push({t:'06:00-09:00',a:'–°–æ–Ω +3—á',c:'bg-indigo-100',id:'sleep2'});
      s.push({t:'09:00-09:30',a:'–ü–æ–¥—ä–µ–º',c:'bg-indigo-200',id:'wake',supps:['–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã','–ö—Ä–µ–∞—Ç–∏–Ω']});
      s.push({t:'09:30-10:30',a:'–ó–∞–≤—Ç—Ä–∞–∫',c:'bg-green-200',id:'breakfast',supps:['–ú—É–ª—å—Ç–∏-–í–∏—Ç–∞–º–∏–Ω—ã','–û–º–µ–≥–∞ 3']});
      if(repair){
        s.push({t:'10:30-13:30',a:'–†–µ–º–æ–Ω—Ç 3—á',c:'bg-yellow-200',id:'repair1'});
        s.push({t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'});
        s.push({t:'14:30-18:30',a:'–†–µ–º–æ–Ω—Ç 4—á',c:'bg-yellow-300',id:'repair2'});
      } else {
        s.push({t:'10:30-13:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-100',id:'free2'});
        s.push({t:'13:30-14:30',a:'–û–±–µ–¥',c:'bg-green-100',id:'lunch'});
        s.push({t:'14:30-18:30',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free3'});
      }
    }

    if(gym){
      s.push(
        {t:'19:00-19:30',a:'–ö –∑–∞–ª—É',c:'bg-red-100',id:'gym1',supps:['–ë–µ—Ç–∞-–∞–ª–∞–Ω–∏–Ω','–¶–∏—Ç—Ä—É–ª–∏–Ω']},
        {t:'19:30-21:00',a:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',c:'bg-red-300',id:'gym'},
        {t:'21:00-21:30',a:'–û—Ç –∑–∞–ª–∞',c:'bg-red-100',id:'gym2',supps:['–ö—Ä–µ–∞—Ç–∏–Ω','–ì–µ–π–Ω–µ—Ä']},
        {t:'21:30-22:30',a:'–£–∂–∏–Ω',c:'bg-green-200',id:'dinner'},
        {t:'22:30-23:30',a:'–ö—É—Ä—Å',c:'bg-purple-200',id:'course'},
        {t:'23:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']}
      );
    } else {
      if(work){
        s.push({t:'19:00-20:00',a:'–£–∂–∏–Ω',c:'bg-green-200',id:'dinner'});
        s.push({t:'20:00-22:00',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-300',id:'course'});
        s.push({t:'22:00-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']});
      } else {
        s.push({t:'18:30-19:30',a:'–£–∂–∏–Ω',c:'bg-green-200',id:'dinner'});
        s.push({t:'19:30-21:30',a:'–ö—É—Ä—Å 2—á',c:'bg-purple-300',id:'course'});
        s.push({t:'21:30-00:00',a:'–°–≤–æ–±–æ–¥–Ω–æ',c:'bg-gray-200',id:'free',supps:['GABA','B-–∫–æ–º–ø–ª–µ–∫—Å']});
      }
    }

    s.push({t:'00:00',a:'–°–æ–Ω',c:'bg-indigo-300',id:'sleep'});
    return s;
  }

  isCurrent(slot){
    const now = new Date();
    const [start,end] = slot.t.split('-').map(t=>{const [h,m]=t.split(':').map(Number);return h*60+m;});
    const curMins = now.getHours()*60+now.getMinutes();
    return curMins>=start && curMins<=(end||start+30);
  }

  toggleOption(dayIndex,type){
    this.state.schedule[dayIndex][type] = !this.state.schedule[dayIndex][type];
    this.save();
    this.render();
    this.scrollToCurrent();
  }

  render(){
    const dayIndex = this.state.selectedDay;
    const dayDate = this.getDateForDay(dayIndex);
    const slots = this.getSlots(dayIndex);
    const container = document.getElementById('app');
    container.innerHTML='';

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const header = document.createElement('div');
    header.className='p-4';
    header.innerHTML=`<h1 class="text-xl font-bold mb-2">üìÖ ${this.days[dayIndex]} ${dayDate}</h1>`;
    container.appendChild(header);

    // –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å —Ü–≤–µ—Ç–∞–º–∏
    const opts=document.createElement('div');
    opts.className='flex gap-2 mb-4 px-4';
    ['work','gym','repair'].forEach(type=>{
      const btn=document.createElement('button');
      const color=this.colors[type];
      btn.className=`flex-1 py-2 rounded text-white ${this.state.schedule[dayIndex][type]?`bg-${color}-500`:'bg-gray-400'}`;
      btn.innerText=type==='work'?'–†–∞–±–æ—Ç–∞':type==='gym'?'–ó–∞–ª':'–†–µ–º–æ–Ω—Ç';
      btn.addEventListener('click',()=>this.toggleOption(dayIndex,type));
      opts.appendChild(btn);
    });
    container.appendChild(opts);

    // –°–ª–æ—Ç—ã
    const slotsContainer=document.createElement('div');
    slotsContainer.className='flex-1 overflow-y-auto px-4';
    slots.forEach(slot=>{
      const key=`${dayDate}-${slot.id}`;
      const slotDiv=document.createElement('div');
      slotDiv.className=`slot p-3 mb-2 rounded ${slot.c} ${this.isCurrent(slot)?'current-time':''}`;
      
      // –í–Ω–µ—à–Ω—è—è –∫–Ω–æ–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
      const taskBtn=`<button class="task-btn w-6 h-6 border-2 rounded ${this.state.completed[key]?'bg-green-500':'border-gray-400'}">${this.state.completed[key]?'‚úì':''}</button>`;

      // –ë–ª–æ–∫ —Å–æ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–º–∏ –¥–æ–±–∞–≤–∫–∞–º–∏
      let suppHtml='';
      if(slot.supps){
        suppHtml='<div class="mt-1 pt-1 border-t border-teal-300 bg-teal-50 px-2 py-1 rounded">';
        slot.supps.forEach((s,i)=>{
          const skey=`${key}-${i}`;
          const taken=this.state.supplements[skey];
          suppHtml+=`<div class="flex items-center gap-2 mb-0.5">
            <button class="supp-btn w-4 h-4 border rounded ${taken?'bg-green-500':'border-gray-400'}" data-key="${skey}">${taken?'‚úì':''}</button>
            <span class="text-xs ${taken?'line-through text-gray-500':'text-teal-700'}">üíä ${s}</span>
          </div>`;
        });
        suppHtml+='</div>';
      }

      slotDiv.innerHTML=`<div class="flex justify-between items-start">
        <div>
          <div class="font-semibold">${slot.t}</div>
          <div>${slot.a}</div>
          ${suppHtml}
        </div>
        ${taskBtn}
      </div>`;

      // –ö–ª–∏–∫ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
      const tbtn=slotDiv.querySelector('.task-btn');
      tbtn.addEventListener('click',()=>{
        this.state.completed[key]=!this.state.completed[key];
        this.save();
        this.updateSlot(slotDiv,key);
      });

      // –ö–ª–∏–∫–∏ –Ω–∞ —Å–ø–æ—Ä—Ç–ø–∏—Ç
      slotDiv.querySelectorAll('.supp-btn').forEach(b=>{
        b.addEventListener('click',()=>{
          const skey=b.dataset.key;
          this.state.supplements[skey]=!this.state.supplements[skey];
          this.save();
          this.updateSupp(b,skey);
        });
      });

      slotsContainer.appendChild(slotDiv);
      this.slotsElements[key]=slotDiv;
    });
    container.appendChild(slotsContainer);

    // –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –¥–Ω–µ–π
    const footer=document.createElement('div');
    footer.className='bg-white border-t flex justify-between p-2 sticky bottom-0';
    this.days.forEach((d,i)=>{
      const btn=document.createElement('button');
      btn.className=`flex-1 py-2 mx-1 rounded ${i===dayIndex?'bg-blue-500 text-white':'bg-gray-200'}`;
      btn.innerText=d;
      btn.addEventListener('click',()=>{
        this.state.selectedDay=i;
        this.render();
        this.scrollToCurrent();
      });
      footer.appendChild(btn);
    });
    container.appendChild(footer);
  }

  updateSlot(slotDiv,key){
    const done=this.state.completed[key];
    const btn=slotDiv.querySelector('.task-btn');
    btn.className=`task-btn w-6 h-6 border-2 rounded ${done?'bg-green-500':'border-gray-400'}`;
    btn.innerText=done?'‚úì':'';
    if(done) slotDiv.classList.add('opacity-80'); else slotDiv.classList.remove('opacity-80');
  }

  updateSupp(btn,key){
    const taken=this.state.supplements[key];
    btn.className=`supp-btn w-4 h-4 border rounded ${taken?'bg-green-500':'border-gray-400'}`;
    btn.innerText=taken?'‚úì':'';
    const label=btn.nextElementSibling;
    if(label) label.className=`text-xs ${taken?'line-through text-gray-500':'text-teal-700'}`;
  }

  scrollToCurrent(){
    const now=new Date();
    const dayIndex=this.state.selectedDay;
    if(dayIndex !== (now.getDay()===0?6:now.getDay()-1)) return;
    const slots=Object.values(this.slotsElements);
    for(const s of slots){
      if(s.classList.contains('current-time')){
        s.scrollIntoView({behavior:'smooth',block:'center'});
        break;
      }
    }
  }
}

const app=new Planner();
</script>
</body>
</html>
